<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VANTEX - Syst√®me de Paiement</title>
    <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAamaJn-3EQvRaLOhV7MB8U",
  authDomain: "vantex-664f1.firebaseapp.com",
  projectId: "vantex-664f1",
  storageBucket: "vantex-664f1.firebasestorage.app",
  messagingSenderId: "762779596180",
  appId: "1:762779596180:web:addb5330bf"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
   <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
// Configuration Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAamaJn-3EQvRaLOhV7MB8U",
  authDomain: "vantex-664f1.firebaseapp.com",
  projectId: "vantex-664f1",
  storageBucket: "vantex-664f1.firebasestorage.app",
  messagingSenderId: "762779596180",
  appId: "1:762779596180:web:addb5330bf"
};

// Initialiser Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
console.log('üî• Firebase connect√©');

// Sauvegarder sur Firebase
window.saveToFirebase = async function(collection, data) {
    try {
        const docId = data.id ? data.id.toString() : Date.now().toString();
        await db.collection(collection).doc(docId).set(data);
        console.log(`‚úÖ ${collection} sauvegard√©:`, docId);
    } catch (error) {
        console.error(`‚ùå Erreur sauvegarde ${collection}:`, error);
    }
};

window.deleteFromFirebase = async function(collection, id) {
    try {
        await db.collection(collection).doc(id.toString()).delete();
        console.log(`‚úÖ Supprim√© de Firebase: ${collection}/${id}`);
    } catch (error) {
        console.error(`‚ùå Erreur suppression Firebase:`, error);
    }
};

window.deleteByEmailFromFirebase = async function(collection, email) {
    try {
        const snapshot = await db.collection(collection).where('accountEmail', '==', email).get();
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        console.log(`‚úÖ Supprim√© ${collection} pour ${email}`);
    } catch (error) {
        console.error(`‚ùå Erreur suppression Firebase:`, error);
    }
};

// R√©cup√©rer depuis Firebase
window.getFromFirebase = async function(collection) {
    try {
        const snapshot = await db.collection(collection).get();
        const items = [];
        snapshot.forEach(doc => {
            const data = {id: doc.id, ...doc.data()};
            // Ignorer les comptes marqu√©s comme supprim√©s
            if (!data.deleted) {
                items.push(data);
            }
        });
        console.log(`‚úÖ ${collection} charg√©:`, items.length);
        return items;
    } catch (error) {
        console.error(`‚ùå Erreur chargement ${collection}:`, error);
        return [];
    }
};

// Charger les donn√©es au d√©marrage
window.addEventListener('DOMContentLoaded', async function() {
    console.log('üîÑ Synchronisation Firebase...');
    
    try {
        // Charger les comptes
        const accounts = await getFromFirebase('accounts');
        if (accounts.length > 0) {
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
        }
        
        // Charger les transactions - fusion intelligente
        const transactions = await getFromFirebase('transactions');
        if (transactions.length > 0) {
            const localT = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
            const localIds = new Set(localT.map(t => String(t.id)));
            const newOnes = transactions.filter(t => !localIds.has(String(t.id)));
            const mergedT = [...localT, ...newOnes];
            localStorage.setItem('vantex_transactions', JSON.stringify(mergedT));
        }
        
        // Charger les virements
        const transfers = await getFromFirebase('transfers');
        if (transfers.length > 0) {
            localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
        }
        
        console.log('‚úÖ Synchronisation termin√©e');
        
        // Restaurer la session apr√®s chargement Firebase
        const savedSession = sessionStorage.getItem('vantex_session');
        if (savedSession) {
            const session = JSON.parse(savedSession);
            if (session.type === 'client' && session.email) {
                const allAccounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
                const savedAccount = allAccounts.find(acc => acc.email === session.email);
                if (savedAccount && savedAccount.status !== 'blocked') {
                    // Attendre que le DOM soit pr√™t
                    setTimeout(() => {
                        currentUser = savedAccount;
                        if (typeof showClientInterface === 'function') showClientInterface();
                    }, 100);
                } else {
                    sessionStorage.removeItem('vantex_session');
                }
            } else if (session.type === 'admin') {
                setTimeout(() => {
                    if (typeof window.showAdminPanel === 'function') window.showAdminPanel();
                }, 100);
            }
        }
    } catch (error) {
        console.error('‚ùå Erreur synchronisation:', error);
    }
});

// NOUVEAU : Intercepter TOUTES les modifications de localStorage
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value) {
    // Sauvegarder dans localStorage
    originalSetItem.call(this, key, value);
    
    // Sauvegarder sur Firebase
    if (key === 'vantex_accounts') {
        const accounts = JSON.parse(value);
        accounts.forEach(account => saveToFirebase('accounts', account));
        console.log('üîÑ Comptes synchronis√©s sur Firebase');
    } else if (key === 'vantex_transactions') {
        const transactions = JSON.parse(value);
        transactions.forEach(transaction => saveToFirebase('transactions', transaction));
        console.log('üîÑ Transactions synchronis√©es sur Firebase');
    } else if (key === 'vantex_transfers') {
        const transfers = JSON.parse(value);
        transfers.forEach(transfer => saveToFirebase('transfers', transfer));
        console.log('üîÑ Virements synchronis√©s sur Firebase');
    }
};

// NOUVEAU : Forcer le rechargement des donn√©es toutes les 3 secondes
setInterval(async function() {
    try {
        const accounts = await getFromFirebase('accounts');
        if (accounts.length > 0) {
            const currentAccounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            
            // V√©rifier s'il y a des changements
            if (JSON.stringify(accounts) !== JSON.stringify(currentAccounts)) {
                originalSetItem.call(localStorage, 'vantex_accounts', JSON.stringify(accounts));
                console.log('üîÑ Comptes mis √† jour depuis Firebase');
                
                // Recharger la page si on est sur l'√©cran client
                if (window.location.hash.includes('#client') || document.querySelector('.client-dashboard')) {
                    location.reload();
                }
            }
        }
    } catch (error) {
        console.error('‚ùå Erreur auto-sync:', error);
    }
}, 3000); // Toutes les 3 secondes

console.log('‚úÖ Firebase configur√© avec auto-sync');
</script>

</script> <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #0066CC;
            --light-blue: #B8E0E8;
            --dark-text: #1a1a1a;
            --light-gray: #f5f5f5;
            --white: #ffffff;
            --success: #4CAF50;
            --danger: #f44336;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
            background: 
                linear-gradient(135deg, rgba(10,30,80,0.88) 0%, rgba(0,80,160,0.80) 50%, rgba(10,30,80,0.92) 100%),
                url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=1200&q=80') center/cover no-repeat;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0,120,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0,200,255,0.10) 0%, transparent 50%);
            pointer-events: none;
        }

        .login-container::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0066ff, #00c8ff, #0066ff);
        }

        .login-box {
            background: rgba(255,255,255,0.97);
            padding: 30px 28px;
            border-radius: 22px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.1);
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.5s ease;
            position: relative;
            z-index: 1;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo h1 {
            color: var(--primary-blue);
            font-size: 32px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-text);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,102,204,0.3);
        }

        .user-type-switch {
            text-align: center;
            margin-top: 20px;
        }

        .user-type-switch button {
            background: none;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }

        /* Client Interface */
        .client-container {
            display: none;
            min-height: 100vh;
            background: #f0f4f8;
            position: relative;
        }

        .client-bg-photo {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 240px;
            background: 
                linear-gradient(160deg, rgba(0,30,100,0.92) 0%, rgba(0,80,200,0.85) 60%, rgba(0,150,200,0.80) 100%),
                url('https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=1200&q=80') center/cover no-repeat;
            z-index: 0;
        }

        .header {
            background: transparent;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: none;
            position: relative;
            z-index: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }

        .logo-icon {
            width: 35px;
            height: 35px;
            background: var(--primary-blue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .notification-btn, .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-btn {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .notification-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-avatar {
            background: rgba(255,255,255,0.25);
            color: white;
            font-weight: 700;
            font-size: 14px;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .welcome {
            position: relative;
            z-index: 1;
            padding: 14px 16px 0px;
            background: transparent;
        }

        .welcome h2 {
            font-size: 17px;
            color: white;
            margin-bottom: 2px;
            font-weight: 700;
            text-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        .last-login-badge {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 0;
        }

        /* Carte premium */
        .balance-card {
            background: linear-gradient(135deg, #0a1e5e 0%, #0055b3 55%, #0099cc 100%);
            margin: 12px;
            padding: 22px 20px 20px;
            border-radius: 22px;
            box-shadow: 0 12px 40px rgba(0,80,180,0.35);
            position: relative;
            z-index: 1;
            overflow: hidden;
            color: white;
        }

        /* Cercles d√©coratifs */
        .balance-card::before {
            content: '';
            position: absolute;
            top: -40px; right: -40px;
            width: 160px; height: 160px;
            background: rgba(255,255,255,0.07);
            border-radius: 50%;
        }
        .balance-card::after {
            content: '';
            position: absolute;
            bottom: -30px; left: -20px;
            width: 120px; height: 120px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }

        .balance-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.75);
            font-size: 12px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .checkmark {
            color: #4dff91;
            font-size: 14px;
        }

        .balance-amount {
            font-size: 34px;
            font-weight: 800;
            color: white;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            transition: filter 0.3s ease, opacity 0.3s ease;
        }

        .account-subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            margin-bottom: 18px;
        }

        /* R√©sum√© financier */
        .finance-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .finance-pill {
            background: rgba(255,255,255,0.12);
            border-radius: 12px;
            padding: 10px 12px;
            backdrop-filter: blur(4px);
        }

        .finance-pill-label {
            font-size: 10px;
            color: rgba(255,255,255,0.65);
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .finance-pill-value {
            font-size: 15px;
            font-weight: 700;
            color: white;
        }

        .finance-pill-value.income { color: #4dff91; }
        .finance-pill-value.expense { color: #ff6b6b; }

        /* Graphique sparkline */
        .sparkline-wrap {
            margin-bottom: 20px;
        }
        .sparkline-label {
            font-size: 10px;
            color: rgba(255,255,255,0.55);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Raccourcis redessin√©s */
        .action-buttons {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            margin-bottom: 4px;
        }

        .action-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 8px 8px;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.25s;
            font-size: 11px;
            color: white;
            flex: 1;
            min-width: 0;
            backdrop-filter: blur(4px);
        }

        .action-btn:hover, .action-btn:active {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .action-btn .btn-icon {
            width: 38px;
            height: 38px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .action-btn.full-width {
            grid-column: unset;
            flex: none;
            width: 100%;
        }

        .transactions-section {
            padding: 16px 16px 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 14px;
            color: var(--dark-text);
        }

        /* Groupe de date */
        .tx-date-group {
            font-size: 11px;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 8px 4px 6px;
        }

        .no-transactions {
            background: white;
            padding: 40px 20px;
            border-radius: 15px;
            text-align: center;
            color: #666;
        }

        .no-transactions-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .transaction-item {
            background: white;
            padding: 14px 16px;
            border-radius: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: box-shadow 0.2s;
        }

        .transaction-item:active {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .transaction-info h4 {
            margin-bottom: 3px;
            color: var(--dark-text);
            font-size: 14px;
        }

        .transaction-date {
            color: #999;
            font-size: 12px;
        }

        .transaction-amount {
            font-size: 16px;
            font-weight: 700;
        }

        .transaction-amount.positive { color: #27ae60; }
        .transaction-amount.negative { color: #e74c3c; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary-blue);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .nav-item {
            color: white;
            text-align: center;
            cursor: pointer;
            flex: 1;
            padding: 3px;
            transition: all 0.3s;
        }

        .nav-item:hover {
            opacity: 0.8;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .nav-label {
            font-size: 11px;
        }

        /* Admin Panel */
        .admin-container {
            display: none;
            min-height: 100vh;
            background: var(--light-gray);
        }

        .admin-header {
            background: var(--primary-blue);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 24px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .admin-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .admin-tab {
            background: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .admin-tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .form-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .form-card h3 {
            margin-bottom: 20px;
            color: var(--dark-text);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--dark-text);
        }

        .action-buttons-admin {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-info {
            background: #2196F3;
            color: white;
        }

        .btn-small:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #e8f5e9;
            color: var(--success);
        }

        .status-blocked {
            background: #ffebee;
            color: var(--danger);
        }

        /* Modal */
        /* Modal Profil Client */
        .profile-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            justify-content: center;
            align-items: flex-start;
            padding-top: 60px;
        }
        .profile-modal-overlay.active {
            display: flex;
        }
        .profile-modal-box {
            background: white;
            border-radius: 20px;
            padding: 30px 25px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .profile-close-btn {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            background: #e74c3c;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .profile-info-row {
            margin-bottom: 15px;
        }
        .profile-info-label {
            font-size: 13px;
            color: #888;
            margin-bottom: 3px;
        }
        .profile-info-value {
            font-size: 16px;
            font-weight: 700;
            color: #222;
        }
        .profile-logout-btn {
            border: 1px solid #e74c3c;
            color: #e74c3c;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--dark-text);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #e8f5e9;
            color: var(--success);
        }

        .alert-error {
            background: #ffebee;
            color: var(--danger);
        }

        @media (max-width: 768px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .admin-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .balance-amount {
                font-size: 36px;
            }
        }
        @keyframes fadeInOut {
            from { opacity: 0; transform: translateY(-8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div style="text-align:center; margin-bottom:20px;">
                <div id="secretLogoBtn" style="width:60px; height:60px; background:var(--primary-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 14px; cursor:pointer;" onclick="handleSecretClick()">
                    <span style="color:white; font-size:26px; font-weight:900;">V</span>
                </div>
                <h1 style="color:#1a1a2e; font-size:17px; font-weight:800; margin-bottom:4px;">VANTEX - Votre espace client</h1>
            </div>
            <div id="loginAlert" class="alert"></div>
            <form id="loginForm">
                <div class="form-group" style="margin-bottom:14px;">
                    <label for="loginEmail" style="color:#555; font-size:13px; font-weight:600;">Votre adresse e-mail</label>
                    <input type="text" id="loginEmail" required placeholder="@mail" style="background:#f8f9fb; border:2px solid #e8ecf0; border-radius:12px; padding:12px 14px; font-size:14px; width:100%; box-sizing:border-box; outline:none;">
                </div>
                <div class="form-group" style="margin-bottom:14px;">
                    <label for="loginPassword" style="color:#555; font-size:13px; font-weight:600;">Votre code pin</label>
                    <input type="password" id="loginPassword" required placeholder="@code" style="background:#f8f9fb; border:2px solid #e8ecf0; border-radius:12px; padding:12px 14px; font-size:14px; width:100%; box-sizing:border-box; outline:none;">
                </div>
                <button type="submit" style="width:100%; padding:13px; background:var(--primary-blue); color:white; border:none; border-radius:12px; font-size:15px; font-weight:700; cursor:pointer; margin-top:4px; letter-spacing:0.5px;">Se connecter ‚Üí</button>
            </form>
            <div class="user-type-switch" style="display:none;">
                <button onclick="switchToAdmin()" style="color: #999;">Connexion Administration</button>
            </div>
        </div>
    </div>

    <!-- Client Interface -->
    <div class="client-container" id="clientInterface">
        <div class="client-bg-photo"></div>
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üè¶</div>
                VANTEX
            </div>
            <div class="user-info">
                <div class="notification-btn">üîî</div>
                <div class="user-avatar" id="userAvatar" onclick="showProfileModal()" style="cursor:pointer;">FK</div>
            </div>
        </div>

        <!-- Bandeau notification client -->
        <div id="clientNotifBanner" style="display:none; margin:0 12px; border-radius:12px; padding:12px 16px; font-size:14px; font-weight:600; animation:fadeInOut 0.4s ease;">
            <span id="clientNotifText"></span>
        </div>

        <div class="welcome">
            <h2 id="welcomeMsg">Bonjour, <span id="userName">FOFANA KARAMO</span> üëã</h2>
            <p class="last-login-badge" id="lastLoginBadge">üîí Derni√®re connexion : ‚Äî</p>
        </div>

        <!-- Spinner de chargement global -->
        <div id="loadingSpinner" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.75); z-index:99999; align-items:center; justify-content:center; flex-direction:column;">
            <div style="width:48px; height:48px; border:4px solid #e0e0e0; border-top:4px solid var(--primary-blue); border-radius:50%; animation:spin 0.8s linear infinite;"></div>
            <p id="spinnerText" style="margin-top:14px; color:#555; font-size:14px; font-weight:600;">Chargement...</p>
        </div>

        <div class="balance-card">
            <!-- Ligne solde + ≈ìil -->
            <div class="balance-label">
                <span>Solde disponible</span>
                <span class="checkmark">‚úì</span>
                <span onclick="toggleBalance()" id="balanceEyeBtn" style="cursor:pointer; margin-left:auto; display:flex; align-items:center; padding:4px;" title="Afficher/Masquer le solde">
                    <svg id="eyeOpenIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <svg id="eyeClosedIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/>
                        <path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/>
                        <line x1="1" y1="1" x2="23" y2="23"/>
                    </svg>
                </span>
            </div>

            <div class="balance-amount" id="clientBalance">0,00 GNF</div>
            <p class="account-subtitle" id="accountTypeLabel">Compte courant ¬∑ <span id="accountNumMasked">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 0000</span></p>

            <!-- R√©sum√© financier du mois -->
            <div class="finance-summary">
                <div class="finance-pill">
                    <div class="finance-pill-label">‚Üë Re√ßu ce mois</div>
                    <div class="finance-pill-value income" id="monthIncome">0 GNF</div>
                </div>
                <div class="finance-pill">
                    <div class="finance-pill-label">‚Üì D√©pens√© ce mois</div>
                    <div class="finance-pill-value expense" id="monthExpense">0 GNF</div>
                </div>
            </div>

            <!-- Graphique sparkline 7 jours -->
            <div class="sparkline-wrap">
                <div class="sparkline-label">√âvolution sur 7 jours</div>
                <canvas id="sparklineCanvas" height="50" style="width:100%; display:block; border-radius:8px;"></canvas>
            </div>

            <!-- Raccourcis redessin√©s -->
            <div class="action-buttons">
                <button class="action-btn" onclick="showIban()">
                    <div class="btn-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                    </div>
                    <span>Mon IBAN</span>
                </button>
                <button class="action-btn" onclick="openTransferModal()">
                    <div class="btn-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </div>
                    <span>Virement</span>
                </button>
                <button class="action-btn" onclick="showVirtualCard()">
                    <div class="btn-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/><circle cx="7" cy="15" r="1.5" fill="white"/></svg>
                    </div>
                    <span>Ma carte</span>
                </button>
            </div>
        </div>

        <div class="transactions-section">
            <h3 class="section-title">
                ‚ò∞ Historique des transactions
            </h3>
            <!-- Barre de recherche -->
            <div style="display:flex; align-items:center; background:white; border-radius:12px; padding:10px 14px; margin-bottom:12px; box-shadow:var(--shadow); gap:8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="txSearchInput" placeholder="Rechercher une transaction..." oninput="filterTransactions()"
                    style="border:none; outline:none; flex:1; font-size:14px; color:#333; background:transparent;">
                <select id="txFilterType" onchange="filterTransactions()" style="border:none; outline:none; font-size:13px; color:#666; background:transparent; cursor:pointer;">
                    <option value="all">Tout</option>
                    <option value="credit">Entr√©es</option>
                    <option value="debit">Sorties</option>
                </select>
            </div>
            <div id="transactionsList">
                <div class="no-transactions">
                    <div class="no-transactions-icon">üìã</div>
                    <p>Aucune transaction n'a √©t√© effectu√©e sur votre compte.</p>
                </div>
            </div>
        </div>

        <div style="height: 80px;"></div>

        <div class="bottom-nav">
            <div class="nav-item">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Portefeuille</div>
            </div>
            <div class="nav-item" onclick="openTransferModal()">
                <div class="nav-icon">üí∏</div>
                <div class="nav-label">Virement</div>
            </div>
            <div class="nav-item" onclick="showVirtualCard()">
                <div class="nav-icon">üí≥</div>
                <div class="nav-label">Carte virtuelle</div>
            </div>
            <div class="nav-item" onclick="showProfileModal()">
                <div class="nav-icon">üë§</div>
                <div class="nav-label">Mon compte</div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-container" id="adminPanel">
        <div class="admin-header">
            <h1>üéõÔ∏è Panel Administrateur VANTEX</h1>
            <button class="logout-btn" onclick="logoutAdmin()">D√©connexion</button>
        </div>

        <div class="admin-content">
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchTab('dashboard')">Tableau de bord</button>
                <button class="admin-tab" onclick="switchTab('accounts')">Gestion des comptes</button>
                <button class="admin-tab" onclick="switchTab('recharge')">Recharger</button>
                <button class="admin-tab" onclick="switchTab('transfers')">Virements</button>
                <button class="admin-tab" onclick="switchTab('transactions')">Transactions</button>
                <button class="admin-tab" onclick="switchTab('settings')">Param√®tres</button>
                <button class="admin-tab" onclick="switchTab('notifications')">üîî Notifications</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Comptes</div>
                        <div class="stat-value" id="totalAccounts">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Comptes Actifs</div>
                        <div class="stat-value" id="activeAccounts">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Comptes G√©r√©s</div>
                        <div class="stat-value" id="totalBalance">0 comptes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Transactions Aujourd'hui</div>
                        <div class="stat-value" id="todayTransactions">0</div>
                    </div>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="accountsTab" class="tab-content">
                <div class="form-card">
                    <h3>‚ûï Cr√©er un nouveau compte</h3>
                    <div id="createAccountAlert" class="alert"></div>
                    <form id="createAccountForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" id="newAccountLastName" required>
                            </div>
                            <div class="form-group">
                                <label>Pr√©nom</label>
                                <input type="text" id="newAccountFirstName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="newAccountEmail" required>
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="tel" id="newAccountPhone" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pays</label>
                                <select id="newAccountCountry" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;">
                                    <option value="">-- S√©lectionner un pays --</option>
                                    <option value="Guin√©e">üá¨üá≥ Guin√©e</option>
                                    <option value="France">üá´üá∑ France</option>
                                    <option value="C√¥te d'Ivoire">üá®üáÆ C√¥te d'Ivoire</option>
                                    <option value="S√©n√©gal">üá∏üá≥ S√©n√©gal</option>
                                    <option value="Mali">üá≤üá± Mali</option>
                                    <option value="Burkina Faso">üáßüá´ Burkina Faso</option>
                                    <option value="B√©nin">üáßüáØ B√©nin</option>
                                    <option value="Togo">üáπüá¨ Togo</option>
                                    <option value="Niger">üá≥üá™ Niger</option>
                                    <option value="Cameroun">üá®üá≤ Cameroun</option>
                                    <option value="Gabon">üá¨üá¶ Gabon</option>
                                    <option value="Congo">üá®üá¨ Congo</option>
                                    <option value="RD Congo">üá®üá© RD Congo</option>
                                    <option value="Maroc">üá≤üá¶ Maroc</option>
                                    <option value="Alg√©rie">üá©üáø Alg√©rie</option>
                                    <option value="Tunisie">üáπüá≥ Tunisie</option>
                                    <option value="Belgique">üáßüá™ Belgique</option>
                                    <option value="Suisse">üá®üá≠ Suisse</option>
                                    <option value="Canada">üá®üá¶ Canada</option>
                                    <option value="√âtats-Unis">üá∫üá∏ √âtats-Unis</option>
                                    <option value="Autre">üåç Autre</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mot de passe</label>
                                <input type="password" id="newAccountPassword" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Solde initial</label>
                                <input type="number" id="newAccountBalance" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Devise du compte</label>
                                <select id="newAccountCurrency" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;">
                                    <option value="GNF">üá¨üá≥ GNF ‚Äî Franc Guin√©en</option>
                                    <option value="XOF">üåç XOF ‚Äî Franc CFA</option>
                                    <option value="EUR">üá™üá∫ EUR ‚Äî Euro</option>
                                    <option value="USD">üá∫üá∏ USD ‚Äî Dollar US</option>
                                    <option value="GBP">üá¨üáß GBP ‚Äî Livre Sterling</option>
                                    <option value="CAD">üá®üá¶ CAD ‚Äî Dollar Canadien</option>
                                    <option value="CHF">üá®üá≠ CHF ‚Äî Franc Suisse</option>
                                    <option value="MAD">üá≤üá¶ MAD ‚Äî Dirham</option>
                                    <option value="DZD">üá©üáø DZD ‚Äî Dinar Alg√©rien</option>
                                    <option value="NGN">üá≥üá¨ NGN ‚Äî Naira</option>
                                    <option value="ZAR">üáøüá¶ ZAR ‚Äî Rand</option>
                                    <option value="BRL">üáßüá∑ BRL ‚Äî Real Br√©silien</option>
                                    <option value="ARS">üá¶üá∑ ARS ‚Äî Peso Argentin</option>
                                    <option value="AED">üá¶üá™ AED ‚Äî Dirham √âmirati</option>
                                    <option value="CNY">üá®üá≥ CNY ‚Äî Yuan</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Progression automatique (%)</label>
                                <input type="number" id="newAccountProgress" value="100" min="0" max="100">
                                <small style="color: #666; font-size: 12px;">Pourcentage pour les virements de ce compte</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Message d'erreur si √©chec (optionnel)</label>
                            <input type="text" id="newAccountErrorMsg" placeholder="Ex: V√©rification des informations requise">
                        </div>
                        <button type="submit" class="btn btn-primary">Cr√©er le compte</button>
                    </form>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 20px;">üìã Liste des comptes</h3>
                    <table id="accountsTable">
                        <thead>
                            <tr>
                                <th>Nom du client</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recharge Tab -->
            <div id="rechargeTab" class="tab-content">
                <div class="form-card">
                    <h3>üí∞ Recharger un compte</h3>
                    <div id="rechargeAlert" class="alert"></div>
                    <form id="rechargeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>S√©lectionner le compte</label>
                                <select id="rechargeAccountSelect" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;">
                                    <option value="">-- Choisir un compte --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Montant</label>
                                <input type="number" id="rechargeAmount" required min="1" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Note (optionnel)</label>
                            <input type="text" id="rechargeNote" placeholder="Ex: Recharge mensuelle">
                        </div>
                        <button type="submit" class="btn btn-primary">Recharger</button>
                    </form>
                </div>

                <div class="form-card">
                    <h3>üìâ D√©biter un compte</h3>
                    <div id="debitAlert" class="alert"></div>
                    <form id="debitForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>S√©lectionner le compte</label>
                                <select id="debitAccountSelect" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;">
                                    <option value="">-- Choisir un compte --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Montant</label>
                                <input type="number" id="debitAmount" required min="1" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Note (optionnel)</label>
                            <input type="text" id="debitNote" placeholder="Ex: Retrait">
                        </div>
                        <div id="debitFeeInfo" style="display:none; background:#fff3cd; padding:12px; border-radius:10px; margin-bottom:15px; border-left:4px solid #ffc107;">
                            <p style="margin:0; color:#856404; font-size:13px;">
                                üí∞ Montant : <strong id="debitBaseAmount">0</strong><br>
                                üí∏ Frais (2%) : <strong id="debitFeeAmount">0</strong><br>
                                <span style="font-size:14px;">Total d√©bit√© : <strong id="debitTotalAmount">0</strong></span>
                            </p>
                        </div>
                        <button type="submit" class="btn btn-primary">D√©biter</button>
                    </form>
                </div>
            </div>

            <!-- Transfers Tab -->
            <div id="transfersTab" class="tab-content">
                <div class="form-card">
                    <h3>‚öôÔ∏è Param√®tres des virements</h3>
                    <p style="color: #666; margin-bottom: 15px;">Configurez le comportement automatique des virements</p>
                    <div class="form-row">
        <div class="form-group">
            <label>üí∞ Frais de transaction virements (%)</label>
            <input type="number" id="transactionFeePercent" min="0" max="100" step="0.1" value="2" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
            <small style="color: #666; font-size: 13px;">Frais appliqu√©s aux virements admin (0 = gratuit)</small>
        </div>
        <div class="form-group">
            <label>üí∏ Frais c√¥t√© client (%)</label>
            <input type="number" id="clientFeePercent" min="0" max="100" step="0.1" value="2" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
            <small style="color: #666; font-size: 13px;">Pourcentage affich√© au client lors du virement (modifiable √† volont√©)</small>
        </div>
    </div>
    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Progression automatique (%)</label>
                            <input type="number" id="autoProgress" min="0" max="100" value="100" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                            <small style="color: #666; font-size: 13px;">Les nouveaux virements s'arr√™teront automatiquement √† ce pourcentage</small>
                        </div>
                        <div class="form-group">
                            <label>Message d'erreur (si progression < 100%)</label>
                            <input type="text" id="autoErrorMessage" placeholder="Ex: V√©rification des informations bancaires requise" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                            <small style="color: #666; font-size: 13px;">Ce message sera affich√© si la progression ne va pas √† 100%</small>
                        </div>
                    </div>
                    
                    <button onclick="saveTransferSettings()" class="btn btn-primary">üíæ Enregistrer les param√®tres</button>
                </div>
                
                <div class="form-card">
                    <h3>üí∏ Historique des virements internationaux</h3>
                    <p style="color: #666; margin-bottom: 20px;">Liste de tous les virements effectu√©s par les clients</p>
                    <button onclick="exportTransfers()" class="btn btn-primary" style="margin-bottom: 20px;">üì• Exporter en CSV</button>
                </div>
                <div class="table-container">
                    <table id="transfersTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Montant</th>
                                <th>B√©n√©ficiaire</th>
                                <th>IBAN</th>
                                <th>Banque</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transfersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactionsTab" class="tab-content">
                <div class="form-card">
                    <h3>üìä Historique des transactions</h3>
                    <button onclick="exportTransactions()" class="btn btn-primary" style="margin-bottom: 20px;">üì• Exporter en CSV</button>
                </div>
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Compte</th>
                                <th>Type</th>
                                <th>Montant</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="form-card">
                    <h3>‚öôÔ∏è Param√®tres du syst√®me</h3>
                    <div id="settingsAlert" class="alert"></div>
                    <div class="form-group">
                        <label>Nom de l'application</label>
                        <input type="text" id="appName" value="VANTEX" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Devise par d√©faut (pour les nouveaux comptes)</label>
                        <input type="text" id="defaultCurrency" value="GNF" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    </div>
                    <button onclick="saveAppSettings()" class="btn btn-primary" style="margin-top: 10px;">üíæ Enregistrer les param√®tres</button>
                    <button onclick="clearAllData()" class="btn btn-danger" style="background: var(--danger); margin-top: 20px;">üóëÔ∏è R√©initialiser toutes les donn√©es</button>
                </div>

                <div class="form-card">
                    <h3>üí± G√©rer les devises des comptes</h3>
                    <p style="color: #666; margin-bottom: 15px;">Changer la devise d'un compte sp√©cifique :</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>S√©lectionner le compte</label>
                            <select id="accountCurrencySelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;">
                                <option value="">-- Choisir un compte --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nouvelle devise</label>
                            <input type="text" id="newCurrencyForAccount" placeholder="Ex: USD, EUR, GNF" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;">
                        </div>
                    </div>
                    <button onclick="changeAccountCurrency()" class="btn btn-primary">üí± Changer la devise</button>
                </div>

                <div class="form-card">
                    <h3>üí± Devises courantes (cliquez pour utiliser)</h3>
                    <p style="color: #666; margin-bottom: 15px;">S√©lectionnez d'abord un compte ci-dessus, puis cliquez sur une devise :</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button onclick="setQuickCurrencyForAccount('GNF')" class="btn-small btn-info">üá¨üá≥ GNF - Franc Guin√©en</button>
                        <button onclick="setQuickCurrencyForAccount('USD')" class="btn-small btn-info">üá∫üá∏ USD - Dollar</button>
                        <button onclick="setQuickCurrencyForAccount('EUR')" class="btn-small btn-info">üá™üá∫ EUR - Euro</button>
                        <button onclick="setQuickCurrencyForAccount('XOF')" class="btn-small btn-info">üåç XOF - Franc CFA</button>
                        <button onclick="setQuickCurrencyForAccount('GBP')" class="btn-small btn-info">üá¨üáß GBP - Livre</button>
                        <button onclick="setQuickCurrencyForAccount('CAD')" class="btn-small btn-info">üá®üá¶ CAD - Dollar Canadien</button>
                        <button onclick="setQuickCurrencyForAccount('CHF')" class="btn-small btn-info">üá®üá≠ CHF - Franc Suisse</button>
                        <button onclick="setQuickCurrencyForAccount('MAD')" class="btn-small btn-info">üá≤üá¶ MAD - Dirham</button>
                        <button onclick="setQuickCurrencyForAccount('NGN')" class="btn-small btn-info">üá≥üá¨ NGN - Naira</button>
                        <button onclick="setQuickCurrencyForAccount('ZAR')" class="btn-small btn-info">üáøüá¶ ZAR - Rand</button>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div id="notificationsTab" class="tab-content">
                <div class="form-card">
                    <h3>üîî Cr√©er une notification client</h3>
                    <p style="color:#666; margin-bottom:20px;">La notification s'affichera en boucle (5 sec visible / 5 sec cach√©e) dans le compte du client s√©lectionn√©.</p>
                    <div id="notifAlert" class="alert"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Compte client</label>
                            <select id="notifAccountSelect" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;">
                                <option value="">-- Choisir un compte --</option>
                                <option value="ALL">üì¢ Tous les comptes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Type de notification</label>
                            <select id="notifType" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;">
                                <option value="info">‚ÑπÔ∏è Information</option>
                                <option value="success">‚úÖ Succ√®s</option>
                                <option value="warning">‚ö†Ô∏è Avertissement</option>
                                <option value="danger">‚ùå Alerte</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Message de la notification</label>
                        <input type="text" id="notifMessage" placeholder="Ex: Votre virement a √©t√© valid√© avec succ√®s !" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;">
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button onclick="createNotification()" class="btn btn-primary" style="flex:1;">üîî Envoyer la notification</button>
                        <button onclick="clearAllNotifications()" class="btn btn-danger" style="flex:1;background:var(--danger);">üóëÔ∏è Supprimer toutes les notifications</button>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom:20px;">üìã Notifications actives</h3>
                    <table id="notificationsTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Type</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="notificationsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal D√©tail Transaction -->
       <div id="txDetailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:flex-end; justify-content:center; backdrop-filter:blur(4px);" onclick="if(event.target===this)closeTxDetail()">
        <div id="txDetailContent" style="background:white;border-radius:28px 28px 0 0;max-width:500px;width:100%;max-height:88vh;overflow-y:auto;padding:0 0 30px;">
            <div style="width:40px;height:4px;background:#e0e0e0;border-radius:2px;margin:14px auto 20px;"></div>
        </div>
    </div>

    <!-- Modal Confirmation PIN -->
    <div id="pinConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); z-index:99998; align-items:center; justify-content:center; padding:20px;">
        <div style="background:white; border-radius:20px; padding:28px 24px; width:100%; max-width:360px; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <div style="font-size:40px; margin-bottom:12px;">üîí</div>
            <h3 style="font-size:16px; font-weight:700; margin-bottom:6px;" id="pinModalTitle">Confirmation requise</h3>
            <p style="font-size:13px; color:#888; margin-bottom:18px;" id="pinModalDesc">Saisissez votre code PIN pour confirmer</p>
            <input type="password" id="pinInput" placeholder="Code PIN" maxlength="20"
                style="width:100%; padding:13px; border:2px solid #e0e0e0; border-radius:12px; font-size:16px; text-align:center; letter-spacing:4px; margin-bottom:8px; box-sizing:border-box;">
            <p id="pinError" style="color:#e74c3c; font-size:13px; min-height:18px; margin-bottom:10px;"></p>
            <div style="display:flex; gap:10px;">
                <button onclick="cancelPinConfirm()" style="flex:1; padding:12px; background:#f0f0f0; color:#555; border:none; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer;">Annuler</button>
                <button onclick="validatePin()" style="flex:1; padding:12px; background:var(--primary-blue); color:white; border:none; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer;">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modal for Recharge/Edit -->
    <!-- Modal Profil Client -->
    <div class="profile-modal-overlay" id="profileModalOverlay" onclick="if(event.target===this)closeProfileModal()">
        <div class="profile-modal-box">
            <button class="profile-close-btn" onclick="closeProfileModal()">‚úï</button>
            <p style="font-size:13px; color:#333; margin-bottom:20px;">‚ñ™ Vos informations de compte :</p>
            <div class="profile-info-row">
                <div class="profile-info-label">Type de Compte :</div>
                <div class="profile-info-value">Compte courant</div>
            </div>
            <div class="profile-info-row">
                <div class="profile-info-label">Titulaire du Compte :</div>
                <div class="profile-info-value" id="profileName">-</div>
            </div>
            <div class="profile-info-row">
                <div class="profile-info-label">Pays de r√©sidence :</div>
                <div class="profile-info-value" id="profileCountry">-</div>
            </div>
            <div class="profile-info-row">
                <div class="profile-info-label">Adresse de r√©sidence :</div>
                <div class="profile-info-value" id="profilePhone">-</div>
            </div>
            <div class="profile-info-row">
                <div class="profile-info-label">Adresse e-mail :</div>
                <div class="profile-info-value" id="profileEmail">-</div>
            </div>
            <div class="profile-info-row">
                <div class="profile-info-label">Num√©ro de t√©l√©phone :</div>
                <div class="profile-info-value" id="profilePhoneNumber">-</div>
            </div>
            <button class="profile-logout-btn" onclick="logoutClient()">Se d√©connecter ‚Üí</button>
        </div>
    </div>

    <div class="modal" id="rechargeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Recharger le compte</h3>
                <button class="close-modal" onclick="closeModal('rechargeModal')">√ó</button>
            </div>
            <div id="modalAlert" class="alert"></div>
            <form id="modalRechargeForm">
                <div class="form-group">
                    <label>Montant (GNF)</label>
                    <input type="number" id="modalRechargeAmount" required min="1">
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <input type="text" id="modalRechargeNote">
                </div>
                <button type="submit" class="btn btn-primary">Confirmer</button>
            </form>
        </div>
    </div>

    <!-- Modal for International Transfer -->
    <div id="transferModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#f0f4f8; z-index:9000; overflow-y:auto;">

        <!-- Header avec fond photo -->
        <div style="position:relative;background:linear-gradient(160deg,rgba(10,30,90,0.93) 0%,rgba(0,90,200,0.87) 55%,rgba(0,140,180,0.85) 100%),url('https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?w=1200&q=80') center/cover no-repeat;padding:20px 20px 36px;">
            <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
                <button onclick="closeTransferPage()" style="width:40px;height:40px;background:rgba(255,255,255,0.18);border:2px solid rgba(255,255,255,0.3);border-radius:50%;font-size:18px;cursor:pointer;color:white;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);">‚Üê</button>
                <div>
                    <p style="color:rgba(255,255,255,0.7);font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;margin:0 0 3px;">Transaction s√©curis√©e</p>
                    <h3 style="margin:0;font-size:22px;font-weight:800;color:white;text-shadow:0 2px 10px rgba(0,0,0,0.3);">Effectuer un virement</h3>
                </div>
            </div>
            <!-- Mini r√©sum√© solde dans le header -->
            <div style="background:rgba(255,255,255,0.12);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.2);border-radius:14px;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:16px;">üí≥</span>
                    <span style="color:rgba(255,255,255,0.8);font-size:13px;font-weight:600;">Solde disponible</span>
                </div>
                <span id="headerBalance" style="color:white;font-size:15px;font-weight:800;"></span>
            </div>
        </div>

        <div style="max-width:600px;margin:-16px auto 0;padding:0 16px 30px;position:relative;z-index:1;">
            <div id="transferAlert" class="alert"></div>
            <form id="transferForm">

                <!-- Choix du type de transfert -->
                <div style="background:white;border-radius:20px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.10);margin-bottom:14px;">
                    <p style="font-weight:700;font-size:13px;color:#aaa;text-transform:uppercase;letter-spacing:0.8px;margin:0 0 14px;">Type de transfert</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div id="typeCardMobile" onclick="selectTransferType('mobile')" style="border:2px solid #eef0f4;border-radius:16px;padding:18px 10px;text-align:center;cursor:pointer;transition:all 0.25s;background:#fafbfd;position:relative;overflow:hidden;">
                            <div style="width:50px;height:50px;background:linear-gradient(135deg,#ff7043,#ff9800);border-radius:14px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 12px rgba(255,112,67,0.3);">üì±</div>
                            <div style="font-weight:700;font-size:13px;color:#222;">Transfert Mobile</div>
                            <div style="font-size:11px;color:#aaa;margin-top:3px;">Mobile Money, Wave‚Ä¶</div>
                        </div>
                        <div id="typeCardBank" onclick="selectTransferType('bank')" style="border:2px solid #eef0f4;border-radius:16px;padding:18px 10px;text-align:center;cursor:pointer;transition:all 0.25s;background:#fafbfd;position:relative;overflow:hidden;">
                            <div style="width:50px;height:50px;background:linear-gradient(135deg,#0052cc,#0091ff);border-radius:14px;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 12px rgba(0,82,204,0.3);">üè¶</div>
                            <div style="font-weight:700;font-size:13px;color:#222;">Virement Bancaire</div>
                            <div style="font-size:11px;color:#aaa;margin-top:3px;">IBAN, SWIFT‚Ä¶</div>
                        </div>
                    </div>
                </div>

                <!-- Champs principaux -->
                <div style="background:white;border-radius:20px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.10);margin-bottom:14px;display:flex;flex-direction:column;gap:16px;">
                    
                    <!-- Montant -->
                    <div>
                        <p style="font-weight:700;font-size:13px;color:#aaa;text-transform:uppercase;letter-spacing:0.8px;margin:0 0 8px;">Montant du virement</p>
                        <div style="display:flex;gap:10px;">
                            <input type="number" id="transferAmount" required min="0.01" step="0.01" placeholder="0.00"
                                style="flex:1;padding:14px 16px;border:2px solid #eef0f4;border-radius:14px;font-size:18px;font-weight:700;box-sizing:border-box;outline:none;transition:border 0.2s;background:#fafbfd;"
                                onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #eef0f4'">
                            <input type="text" id="transferCurrency" readonly
                                style="width:80px;padding:14px 10px;border:2px solid #eef0f4;border-radius:14px;font-size:14px;font-weight:700;background:#f0f4f8;text-align:center;color:#0052cc;">
                        </div>
                    </div>

                    <div style="height:1px;background:#f5f5f5;"></div>

                    <!-- B√©n√©ficiaire -->
                    <div>
                        <p style="font-weight:700;font-size:13px;color:#aaa;text-transform:uppercase;letter-spacing:0.8px;margin:0 0 8px;">Nom du b√©n√©ficiaire</p>
                        <input type="text" id="transferBeneficiary" required placeholder="Pr√©nom et Nom"
                            style="width:100%;padding:14px 16px;border:2px solid #eef0f4;border-radius:14px;font-size:15px;box-sizing:border-box;outline:none;transition:border 0.2s;background:#fafbfd;"
                            onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #eef0f4'">
                    </div>
                </div>

                <!-- Champs Mobile Money -->
                <div id="mobileFields" style="display:none;">
                    <div style="background:white;border-radius:20px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.10);margin-bottom:14px;display:flex;flex-direction:column;gap:16px;">
                        <p style="font-weight:700;font-size:13px;color:#aaa;text-transform:uppercase;letter-spacing:0.8px;margin:0;">Informations Mobile Money</p>
                        <div>
                            <p style="font-weight:600;font-size:13px;color:#555;margin:0 0 8px;">Op√©rateur Mobile</p>
                            <div style="position:relative;">
                                <select id="transferOperator" style="width:100%;padding:14px 16px;border:2px solid #eef0f4;border-radius:14px;font-size:15px;box-sizing:border-box;outline:none;background:#fafbfd;appearance:none;-webkit-appearance:none;cursor:pointer;" onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #eef0f4'">
                                    <option value="">-- Choisir un op√©rateur --</option>
                                    <option value="Orange Money">üü† Orange Money</option>
                                    <option value="Wave">üîµ Wave</option>
                                    <option value="MTN Mobile Money">üü° MTN Mobile Money</option>
                                    <option value="Moov Money">üü¢ Moov Money</option>
                                </select>
                                <span style="position:absolute;right:14px;top:50%;transform:translateY(-50%);color:#aaa;pointer-events:none;">‚ñæ</span>
                            </div>
                        </div>
                        <div style="height:1px;background:#f5f5f5;"></div>
                        <div>
                            <p style="font-weight:600;font-size:13px;color:#555;margin:0 0 8px;">Num√©ro de t√©l√©phone</p>
                            <input type="tel" id="transferMobileNumber" placeholder="Ex: +221 77 000 00 00"
                                style="width:100%;padding:14px 16px;border:2px solid #eef0f4;border-radius:14px;font-size:15px;box-sizing:border-box;outline:none;transition:border 0.2s;background:#fafbfd;"
                                onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #eef0f4'">
                        </div>
                        <div style="height:1px;background:#f5f5f5;"></div>
                        <div>
                            <p style="font-weight:600;font-size:13px;color:#555;margin:0 0 8px;">Pays</p>
                            <div style="position:relative;">
                                <select id="transferMobileCountry" style="width:100%;padding:14px 16px;border:2px solid #eef0f4;border-radius:14px;font-size:15px;box-sizing:border-box;outline:none;background:#fafbfd;appearance:none;-webkit-appearance:none;cursor:pointer;" onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #eef0f4'">
                                    <option value="">-- Pays --</option>
                                    <optgroup label="üåç Afrique de l'Ouest">
                                        <option value="S√©n√©gal">üá∏üá≥ S√©n√©gal</option>
                                        <option value="Guin√©e">üá¨üá≥ Guin√©e</option>
                                        <option value="C√¥te d'Ivoire">üá®üáÆ C√¥te d'Ivoire</option>
                                        <option value="Mali">üá≤üá± Mali</option>
                                        <option value="Burkina Faso">üáßüá´ Burkina Faso</option>
                                        <option value="Niger">üá≥üá™ Niger</option>
                                        <option value="Togo">üáπüá¨ Togo</option>
                                        <option value="B√©nin">üáßüáØ B√©nin</option>
                                        <option value="Ghana">üá¨üá≠ Ghana</option>
                                        <option value="Nigeria">üá≥üá¨ Nigeria</option>
                                    </optgroup>
                                    <optgroup label="üåç Afrique Centrale & Est">
                                        <option value="Cameroun">üá®üá≤ Cameroun</option>
                                        <option value="Congo">üá®üá¨ Congo</option>
                                        <option value="RD Congo">üá®üá© RD Congo</option>
                                        <option value="Gabon">üá¨üá¶ Gabon</option>
                                        <option value="Kenya">üá∞üá™ Kenya</option>
                                        <option value="Tanzanie">üáπüáø Tanzanie</option>
                                        <option value="Rwanda">üá∑üáº Rwanda</option>
                                        <option value="Ouganda">üá∫üá¨ Ouganda</option>
                                    </optgroup>
                                    <optgroup label="üåç Afrique du Nord">
                                        <option value="Maroc">üá≤üá¶ Maroc</option>
                                        <option value="Alg√©rie">üá©üáø Alg√©rie</option>
                                        <option value="Tunisie">üáπüá≥ Tunisie</option>
                                        <option value="√âgypte">üá™üá¨ √âgypte</option>
                                    </optgroup>
                                    <optgroup label="üá™üá∫ Europe">
                                        <option value="France">üá´üá∑ France</option>
                                        <option value="Belgique">üáßüá™ Belgique</option>
                                        <option value="Suisse">üá®üá≠ Suisse</option>
                                        <option value="Allemagne">üá©üá™ Allemagne</option>
                                        <option value="Espagne">üá™üá∏ Espagne</option>
                                        <option value="Italie">üáÆüáπ Italie</option>
                                        <option value="Portugal">üáµüáπ Portugal</option>
                                        <option value="Royaume-Uni">üá¨üáß Royaume-Uni</option>
                                    </optgroup>
                                    <optgroup label="üåé Am√©riques">
                                        <option value="√âtats-Unis">üá∫üá∏ √âtats-Unis</option>
                                        <option value="Canada">üá®üá¶ Canada</option>
                                        <option value="Br√©sil">üáßüá∑ Br√©sil</option>
                                    </optgroup>
                                    <optgroup label="üåè Asie">
                                        <option value="√âmirats Arabes Unis">üá¶üá™ √âmirats Arabes Unis</option>
                                        <option value="Arabie Saoudite">üá∏üá¶ Arabie Saoudite</option>
                                        <option value="Chine">üá®üá≥ Chine</option>
                                        <option value="Inde">üáÆüá≥ Inde</option>
                                    </optgroup>
                                </select>
                                <span style="position:absolute;right:14px;top:50%;transform:translateY(-50%);color:#aaa;pointer-events:none;">‚ñæ</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Champs Bancaires -->
                <div id="bankFields" style="display:none;">
                    <div style="background:white;border-radius:20px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.10);margin-bottom:14px;display:flex;flex-direction:column;gap:16px;">
                        <p style="font-weight:700;font-size:13px;color:#aaa;text-transform:uppercase;letter-spacing:0.8px;margin:0;">Informations Bancaires</p>
                        <div>
                            <p style="font-weight:600;font-size:13px;color:#555;margin:0 0 8px;">IBAN / Num√©ro de Compte</p>
                            <input type="text" id="transferIban" placeholder="Ex: FR76 3000 6000 0112 3456 7890 189"
                                style="width:100%;padding:14px 16px;border:2px solid #eef0f4;border-radius:14px;font-size:14px;font-family:monospace;box-sizing:border-box;outline:none;transition:border 0.2s;background:#fafbfd;"
                                onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #eef0f4'">
                        </div>
                        <div style="height:1px;background:#f5f5f5;"></div>
                        <div>
                            <p style="font-weight:600;font-size:13px;color:#555;margin:0 0 8px;">Code Banque (BIC / SWIFT)</p>
                            <input type="text" id="transferSwift" placeholder="Ex: BNPAFRPP"
                                style="width:100%;padding:14px 16px;border:2px solid #eef0f4;border-radius:14px;font-size:15px;font-family:monospace;letter-spacing:2px;box-sizing:border-box;outline:none;transition:border 0.2s;background:#fafbfd;"
                                onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #eef0f4'">
                        </div>
                        <div style="height:1px;background:#f5f5f5;"></div>
                        <div>
                            <p style="font-weight:600;font-size:13px;color:#555;margin:0 0 8px;">Nom de la Banque</p>
                            <input type="text" id="transferBank" placeholder="Ex: BNP Paribas"
                                style="width:100%;padding:14px 16px;border:2px solid #eef0f4;border-radius:14px;font-size:15px;box-sizing:border-box;outline:none;transition:border 0.2s;background:#fafbfd;"
                                onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #eef0f4'">
                        </div>
                    </div>
                </div>

                <!-- Raison + Solde + Frais + Bouton -->
                <div style="background:white;border-radius:20px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.10);margin-bottom:14px;display:flex;flex-direction:column;gap:16px;">
                    <div>
                        <p style="font-weight:700;font-size:13px;color:#aaa;text-transform:uppercase;letter-spacing:0.8px;margin:0 0 8px;">Raison du virement</p>
                        <input type="text" id="transferReason" required placeholder="Ex: Paiement de facture"
                            style="width:100%;padding:14px 16px;border:2px solid #eef0f4;border-radius:14px;font-size:15px;box-sizing:border-box;outline:none;transition:border 0.2s;background:#fafbfd;"
                            onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #eef0f4'">
                    </div>
                    <div style="height:1px;background:#f5f5f5;"></div>

                    <!-- Solde disponible -->
                    <div style="display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#f0f6ff,#e8f4fd);padding:14px 16px;border-radius:14px;border-left:4px solid #0052cc;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="width:34px;height:34px;background:linear-gradient(135deg,#0052cc,#0091ff);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;">üí∞</div>
                            <span style="font-size:13px;color:#555;font-weight:600;">Solde disponible</span>
                        </div>
                        <span id="transferAvailableBalance" style="font-weight:800;color:#0052cc;font-size:16px;">0.00</span>
                    </div>

                    <!-- Frais -->
                    <div id="clientFeeInfo" style="display:none;background:#fff8e1;padding:14px 16px;border-radius:14px;border-left:4px solid #f39c12;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                            <span style="font-size:13px;color:#888;">Montant du virement</span>
                            <strong id="clientBaseAmount" style="font-size:13px;color:#333;">0</strong>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="font-size:13px;color:#888;">üí∏ Frais</span>
                            <strong id="clientFeeAmount" style="font-size:13px;color:#e67e22;">0</strong>
                        </div>
                        <div style="height:1px;background:#ffe082;margin-bottom:8px;"></div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="font-size:14px;font-weight:700;color:#333;">Total d√©bit√©</span>
                            <strong id="clientTotalAmount" style="font-size:14px;color:#e67e22;">0</strong>
                        </div>
                    </div>
                </div>

                <!-- Bouton Continuer -->
                <button type="submit" style="width:100%;padding:16px;background:linear-gradient(135deg,#0052cc,#0091ff);color:white;border:none;border-radius:16px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(0,82,204,0.35);transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                    Continuer ‚Üí
                </button>
            </form>
        </div>
    </div>

    <!-- Transfer Confirmation Page -->
    <div class="client-container" id="transferConfirmation" style="display: none; position:relative; background:#f0f4f8;">

        <!-- Photo fond header -->
        <div style="position:absolute;top:0;left:0;right:0;height:200px;z-index:0;
            background: linear-gradient(160deg, rgba(10,30,90,0.93) 0%, rgba(0,90,200,0.87) 55%, rgba(0,140,180,0.85) 100%),
            url('https://images.unsplash.com/photo-1563986768494-4dee2763ff3f?w=1200&q=80') center/cover no-repeat;">
        </div>

        <!-- Header -->
        <div class="header" style="background:transparent;position:relative;z-index:1;">
            <div class="logo" style="color:white;">
                <div class="logo-icon">üè¶</div>
                VANTEX
            </div>
            <div class="user-info">
                <div class="notification-btn">üîî</div>
                <div class="user-avatar" id="userAvatarConfirm" style="background:rgba(255,255,255,0.25);color:white;border:2px solid rgba(255,255,255,0.5);">FK</div>
            </div>
        </div>

        <!-- Titre flottant sur la photo -->
        <div style="position:relative;z-index:1;padding:0 16px 20px;">
            <p style="color:rgba(255,255,255,0.8);font-size:12px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;margin:0 0 4px;">S√©curisation</p>
            <h3 style="font-size:22px;color:white;font-weight:800;margin:0;text-shadow:0 2px 8px rgba(0,0,0,0.3);">V√©rification d'identit√©</h3>
        </div>

        <div style="padding: 0 16px 16px; max-width: 500px; margin: 0 auto; position:relative; z-index:1;">

            <!-- Carte d√©tails virement -->
            <div style="background:white;border-radius:20px;padding:22px;box-shadow:0 8px 32px rgba(0,0,0,0.12);margin-bottom:14px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid #f0f0f0;">
                    <span style="font-size:20px;">üßæ</span>
                    <p style="font-size:15px;color:var(--primary-blue);font-weight:700;margin:0;">D√©tails du virement en attente</p>
                </div>

                <div style="display:flex;flex-direction:column;gap:14px;">
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Montant du virement</p>
                        <p style="font-size:26px;font-weight:800;color:#111;margin:0;" id="confirmAmount">0</p>
                    </div>
                    <div style="height:1px;background:#f5f5f5;"></div>
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Nom du b√©n√©ficiaire</p>
                        <p style="font-weight:700;font-size:16px;color:#111;margin:0;" id="confirmBeneficiary">-</p>
                    </div>
                    <div style="height:1px;background:#f5f5f5;"></div>
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">IBAN / Num√©ro de Compte</p>
                        <p style="font-weight:700;font-size:16px;color:#111;margin:0;font-family:monospace;" id="confirmIban">-</p>
                    </div>
                    <div style="height:1px;background:#f5f5f5;"></div>
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Code Banque (BIC / SWIFT)</p>
                        <p style="font-weight:700;font-size:16px;color:#111;margin:0;" id="confirmSwift">-</p>
                    </div>
                    <div style="height:1px;background:#f5f5f5;"></div>
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Nom de la Banque</p>
                        <p style="font-weight:700;font-size:16px;color:#111;margin:0;" id="confirmBank">-</p>
                    </div>
                    <div style="height:1px;background:#f5f5f5;"></div>
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Raison du virement</p>
                        <p style="font-weight:700;font-size:16px;color:#111;margin:0;" id="confirmReason">-</p>
                    </div>
                </div>

                <button onclick="cancelTransferProcess()" style="margin-top:20px;width:100%;padding:12px;border:2px solid #e74c3c;background:white;color:#e74c3c;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#fff5f5'" onmouseout="this.style.background='white'">
                    Annuler le virement ‚Üí
                </button>
            </div>

            <!-- Carte code activation -->
            <div style="background:white;border-radius:20px;padding:22px;box-shadow:0 8px 32px rgba(0,0,0,0.12);">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid #f0f0f0;">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#0052cc,#0091ff);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">üîê</div>
                    <div>
                        <p style="margin:0;font-size:14px;font-weight:700;color:#111;">Code d'activation</p>
                        <p style="margin:0;font-size:12px;color:#999;">Saisissez le code re√ßu pour confirmer</p>
                    </div>
                </div>
                
                <input type="password" id="activationCode" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    style="width:100%;padding:15px;border:2px solid #e8e8e8;border-radius:14px;font-size:18px;text-align:center;letter-spacing:6px;margin-bottom:14px;box-sizing:border-box;outline:none;transition:border 0.2s;"
                    onfocus="this.style.border='2px solid #0052cc'" onblur="this.style.border='2px solid #e8e8e8'">
                
                <button onclick="processTransfer()" style="width:100%;padding:15px;background:linear-gradient(135deg,#0052cc,#0091ff);color:white;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(0,82,204,0.35);transition:all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='none'">
                    Continuer ‚Üí
                </button>
            </div>
        </div>

        <div style="height: 80px;"></div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="backToClientDashboard()">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Portefeuille</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon">üí∏</div>
                <div class="nav-label">Virement</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon">üí≥</div>
                <div class="nav-label">Carte virtuelle</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon">üë§</div>
                <div class="nav-label">Mon compte</div>
            </div>
        </div>
    </div>

    <!-- Transfer Processing Page -->
    <div class="client-container" id="transferProcessing" style="display: none; position: relative; background:#f0f4f8;">

        <!-- Photo fond header -->
        <div style="position:absolute;top:0;left:0;right:0;height:210px;z-index:0;
            background: linear-gradient(160deg, rgba(0,50,20,0.92) 0%, rgba(0,130,60,0.85) 50%, rgba(0,90,40,0.92) 100%),
            url('https://images.unsplash.com/photo-1554224155-6726b3ff858f?w=1200&q=80') center/cover no-repeat;">
        </div>

        <!-- Header -->
        <div class="header" style="background:transparent;position:relative;z-index:1;">
            <div class="logo" style="color:white;">
                <div class="logo-icon">üè¶</div>
                VANTEX
            </div>
        </div>

        <!-- Titre sur la photo -->
        <div style="position:relative;z-index:1;padding:0 20px 22px;">
            <p style="color:rgba(255,255,255,0.75);font-size:12px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;margin:0 0 4px;">Traitement</p>
            <h2 style="color:white;font-size:22px;font-weight:800;margin:0;text-shadow:0 2px 8px rgba(0,0,0,0.3);">Votre ordre de virement en cours...</h2>
        </div>

        <div style="padding: 0 16px 20px; max-width: 600px; margin: 0 auto; position:relative; z-index:1;">

            <!-- Carte statut + barre de progression -->
            <div style="background:white;border-radius:20px;padding:22px;box-shadow:0 8px 32px rgba(0,0,0,0.12);margin-bottom:14px;">

                <!-- Statut identit√© -->
                <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;padding-bottom:18px;border-bottom:1px solid #f0f0f0;">
                    <div style="width:44px;height:44px;background:linear-gradient(135deg,#00b09b,#27ae60);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">‚úÖ</div>
                    <div>
                        <p style="margin:0;font-size:14px;font-weight:700;color:#111;">V√©rification d'identit√© effectu√©e</p>
                        <p style="margin:0;font-size:12px;color:#27ae60;font-weight:600;">Identit√© confirm√©e avec succ√®s</p>
                    </div>
                </div>

                <p style="color:#888;font-size:13px;line-height:1.6;margin:0 0 20px;">
                    Veuillez patienter la fin du virement des fonds vers votre banque avant d'actualiser cette page.
                </p>

                <!-- Barre de progression moderne -->
                <div style="margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:12px;color:#888;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Progression du virement</span>
                    <span id="progressText" style="font-size:14px;font-weight:800;color:var(--primary-blue);">0%</span>
                </div>
                <div style="background:#e8f4fd;height:14px;border-radius:10px;overflow:hidden;position:relative;margin-bottom:6px;">
                    <div id="progressBar" style="background:linear-gradient(90deg,#0052cc,#0091ff);height:100%;width:0%;border-radius:10px;transition:width 0.8s ease;position:relative;">
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 1.5s infinite;"></div>
                    </div>
                </div>
            </div>

            <!-- Carte d√©tails virement -->
            <div style="background:white;border-radius:20px;padding:22px;box-shadow:0 8px 32px rgba(0,0,0,0.12);margin-bottom:14px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid #f0f0f0;">
                    <span style="font-size:20px;">üßæ</span>
                    <p style="font-size:15px;color:var(--primary-blue);font-weight:700;margin:0;">D√©tails du virement en cours</p>
                </div>
                <div style="display:flex;flex-direction:column;gap:14px;">
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Montant du virement</p>
                        <p style="font-size:24px;font-weight:800;color:#111;margin:0;" id="processingAmount">-</p>
                    </div>
                    <div style="height:1px;background:#f5f5f5;"></div>
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Nom du b√©n√©ficiaire</p>
                        <p style="font-weight:700;font-size:16px;color:#111;margin:0;" id="processingBeneficiary">-</p>
                    </div>
                    <div style="height:1px;background:#f5f5f5;"></div>
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">IBAN / Num√©ro de Compte</p>
                        <p style="font-weight:700;font-size:16px;color:#111;margin:0;font-family:monospace;" id="processingIban">-</p>
                    </div>
                    <div style="height:1px;background:#f5f5f5;"></div>
                    <div>
                        <p style="color:#aaa;margin:0 0 3px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Nom de la Banque</p>
                        <p style="font-weight:700;font-size:16px;color:#111;margin:0;" id="processingBank">-</p>
                    </div>
                </div>
            </div>

            <!-- Message erreur -->
            <div id="errorMessage" style="display:none;background:white;border-radius:20px;padding:22px;box-shadow:0 8px 32px rgba(0,0,0,0.12);border-top:4px solid #e74c3c;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
                    <div style="width:44px;height:44px;background:#fff0f0;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;">‚ùå</div>
                    <p style="font-weight:700;color:#e74c3c;font-size:16px;margin:0;">√âchec du virement</p>
                </div>
                <p style="color:#888;font-size:14px;margin:0 0 16px;line-height:1.5;" id="errorText"></p>
                <button onclick="backToClientDashboard()" style="width:100%;padding:13px;background:#e74c3c;color:white;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;">
                    Retour au tableau de bord
                </button>
            </div>

            <!-- Message succ√®s -->
            <div id="successMessage" style="display:none;background:white;border-radius:20px;padding:22px;box-shadow:0 8px 32px rgba(0,0,0,0.12);border-top:4px solid #27ae60;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
                    <div style="width:44px;height:44px;background:#f0fff4;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;">‚úÖ</div>
                    <p style="font-weight:700;color:#27ae60;font-size:16px;margin:0;">Virement r√©ussi !</p>
                </div>
                <p style="color:#888;font-size:14px;margin:0 0 16px;">Votre virement a √©t√© trait√© avec succ√®s</p>
                <button onclick="backToClientDashboard()" style="width:100%;padding:13px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;">
                    Retour au tableau de bord
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize localStorage
        if (!localStorage.getItem('vantex_accounts')) {
            localStorage.setItem('vantex_accounts', JSON.stringify([]));
        }
        if (!localStorage.getItem('vantex_transactions')) {
            localStorage.setItem('vantex_transactions', JSON.stringify([]));
        }
        if (!localStorage.getItem('vantex_transfers')) {
            localStorage.setItem('vantex_transfers', JSON.stringify([]));
        }
        if (!localStorage.getItem('vantex_admin')) {
            localStorage.setItem('vantex_admin', JSON.stringify({
                email: 'ndamcorazon75@gmail.com',
                password: 'Ndamcorazon77'
            }));
        }
        if (!localStorage.getItem('vantex_settings')) {
            localStorage.setItem('vantex_settings', JSON.stringify({
                appName: 'VANTEX',
                defaultCurrency: 'GNF'
            }));
        }
        if (!localStorage.getItem('vantex_transfer_settings')) {
            localStorage.setItem('vantex_transfer_settings', JSON.stringify({
                autoProgress: 100,
                autoErrorMessage: ''
            }));
        }

        let currentUser = null;
        let currentEditAccount = null;
        let allHistoryCache = [];

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => 
                (acc.email === email || acc.phone === email) && acc.password === password
            );

            if (account) {
                if (account.status === 'blocked') {
                    showAlert('loginAlert', 'Compte bloqu√©. Contactez l\'administrateur.', 'error');
                    return;
                }
                currentUser = account;
                // Sauvegarder la session
                sessionStorage.setItem('vantex_session', JSON.stringify({ type: 'client', email: account.email }));
                showClientInterface();
            } else {
                showAlert('loginAlert', 'Email/T√©l√©phone ou mot de passe incorrect', 'error');
            }
        });

        // Acc√®s secret admin via triple clic sur le logo
        let secretClickCount = 0;
        let secretClickTimer = null;
        window.handleSecretClick = function() {
            secretClickCount++;
            if (secretClickTimer) clearTimeout(secretClickTimer);
            secretClickTimer = setTimeout(() => { secretClickCount = 0; }, 1500);
            if (secretClickCount >= 3) {
                secretClickCount = 0;
                window.switchToAdmin();
            }
        }

        window.switchToAdmin = function() {
            const email = prompt('Email administrateur:');
            const password = prompt('Mot de passe:');
            const admin = JSON.parse(localStorage.getItem('vantex_admin'));

            if (email === admin.email && password === admin.password) {
                sessionStorage.setItem('vantex_session', JSON.stringify({ type: 'admin' }));
                showAdminPanel();
            } else {
                alert('Identifiants administrateur incorrects');
            }
        }

        function showClientInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('userAvatar').textContent = initials;
            
            updateClientBalance();
            loadClientTransactions();
        }

        window.showAdminPanel = function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            loadCurrencySettings();
            loadTransferSettings();
            updateDashboard();
            loadAccountsTable();
            loadTransfersTable();
            loadTransactionsTable();
            populateAccountSelects();
        }

        function updateClientBalance() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === currentUser.email);
            if (account) {
                currentUser = account;
                const currency = account.currency || 'GNF';
                document.getElementById('clientBalance').textContent = 
                    formatCurrency(account.balance) + ' ' + currency;
            }
        }

        async function loadClientTransactions() {
            const currency = currentUser.currency || 'GNF';
            
            // Sync Firebase
            try {
                const firebaseTransactions = await window.getFromFirebase('transactions');
                const localTransactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
                if (firebaseTransactions.length > 0) {
                    const localIds = new Set(localTransactions.map(t => String(t.id)));
                    const newFromFirebase = firebaseTransactions.filter(t => !localIds.has(String(t.id)));
                    const merged = [...localTransactions, ...newFromFirebase];
                    localStorage.setItem('vantex_transactions', JSON.stringify(merged));
                }
            } catch(e) { console.log('Firebase transactions:', e); }

            const transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
            const transfers    = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');

            const userTransactions = transactions
                .filter(t => t.accountEmail === currentUser.email)
                .map(t => ({ ...t, sourceType: 'transaction' }));

            const userTransfers = transfers
                .filter(t => t.accountEmail === currentUser.email)
                .map(t => ({
                    id: t.id, accountEmail: t.accountEmail,
                    type: 'debit', amount: t.amount,
                    fee: t.fee,
                    note: 'Virement vers ' + (t.beneficiary || 'b√©n√©ficiaire'),
                    date: t.date, sourceType: 'transfer', status: t.status,
                    // Garder tous les d√©tails du virement
                    beneficiary: t.beneficiary,
                    iban: t.iban,
                    swift: t.swift,
                    bank: t.bank,
                    reason: t.reason,
                    currency: t.currency,
                    transferType: t.transferType,
                    operator: t.operator,
                    mobileNumber: t.mobileNumber,
                    mobileCountry: t.mobileCountry
                }));

            // Remplir le cache global pour showTxDetail
            allHistoryCache = [...userTransactions, ...userTransfers]
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            renderTransactionList(allHistoryCache, currency);
        }

        function showProfileModal() {
            if (!currentUser) return;
            
            // Mapping pays ‚Üí drapeau emoji
            const countryFlags = {
                'Guin√©e': 'üá¨üá≥',
                'France': 'üá´üá∑',
                "C√¥te d'Ivoire": 'üá®üáÆ',
                'S√©n√©gal': 'üá∏üá≥',
                'Mali': 'üá≤üá±',
                'Burkina Faso': 'üáßüá´',
                'B√©nin': 'üáßüáØ',
                'Togo': 'üáπüá¨',
                'Niger': 'üá≥üá™',
                'Cameroun': 'üá®üá≤',
                'Gabon': 'üá¨üá¶',
                'Congo': 'üá®üá¨',
                'RD Congo': 'üá®üá©',
                'Maroc': 'üá≤üá¶',
                'Alg√©rie': 'üá©üáø',
                'Tunisie': 'üáπüá≥',
                'Belgique': 'üáßüá™',
                'Suisse': 'üá®üá≠',
                'Canada': 'üá®üá¶',
                '√âtats-Unis': 'üá∫üá∏',
                'Autre': 'üåç'
            };
            
            const country = currentUser.country || '-';
            const flag = countryFlags[country] || 'üåç';
            const countryWithFlag = country !== '-' ? flag + ' ' + country : '-';
            
            document.getElementById('profileName').textContent = currentUser.name || '-';
            document.getElementById('profileCountry').textContent = countryWithFlag;
            document.getElementById('profilePhone').textContent = currentUser.phone || '-';
            document.getElementById('profileEmail').textContent = currentUser.email || '-';
            document.getElementById('profilePhoneNumber').textContent = currentUser.phone || '-';
            document.getElementById('profileModalOverlay').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModalOverlay').classList.remove('active');
        }

        function logoutClient() {
            if (confirm('Voulez-vous vous d√©connecter ?')) {
                currentUser = null;
            sessionStorage.removeItem('vantex_session');
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('clientInterface').style.display = 'none';
                document.getElementById('loginForm').reset();
            }
        }

        function logoutAdmin() {
            if (confirm('Voulez-vous vous d√©connecter ?')) {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('loginForm').reset();
            }
        }

        // Admin Functions
        function switchTab(tabName) {
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target) event.target.classList.add('active');
            const tabEl = document.getElementById(tabName + 'Tab');
            if (tabEl) tabEl.classList.add('active');
        }

        function updateDashboard() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const transactions = JSON.parse(localStorage.getItem('vantex_transactions'));
            
            const activeAccounts = accounts.filter(acc => acc.status === 'active').length;
            
            const today = new Date().toDateString();
            const todayTransactions = transactions.filter(t => 
                new Date(t.date).toDateString() === today
            ).length;
            
            document.getElementById('totalAccounts').textContent = accounts.length;
            document.getElementById('activeAccounts').textContent = activeAccounts;
            document.getElementById('totalBalance').textContent = accounts.length + ' comptes';
            document.getElementById('todayTransactions').textContent = todayTransactions;
        }

        document.getElementById('createAccountForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const email = document.getElementById('newAccountEmail').value;
            
            if (accounts.find(acc => acc.email === email)) {
                showAlert('createAccountAlert', 'Un compte avec cet email existe d√©j√†', 'error');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem('vantex_settings'));
            const lastName = document.getElementById('newAccountLastName').value;
            const firstName = document.getElementById('newAccountFirstName').value;
            
            // G√©n√©rer un code d'activation unique VTX + 5 chiffres
            function generateActivationCode() {
                const digits = Math.floor(10000 + Math.random() * 90000);
                return 'VTX' + digits;
            }
            let activCode = generateActivationCode();
            // S'assurer que le code est unique
            const allAccounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            while (allAccounts.find(a => a.activationCode === activCode)) {
                activCode = generateActivationCode();
            }

            const newAccount = {
                id: Date.now(),
                lastName: lastName,
                firstName: firstName,
                name: firstName + ' ' + lastName,
                email: email,
                phone: document.getElementById('newAccountPhone').value,
                country: document.getElementById('newAccountCountry').value,
                password: document.getElementById('newAccountPassword').value,
                balance: parseFloat(document.getElementById('newAccountBalance').value) || 0,
                currency: document.getElementById('newAccountCurrency').value || settings.defaultCurrency || 'GNF',
                autoProgress: parseInt(document.getElementById('newAccountProgress').value) || 100,
                autoErrorMessage: document.getElementById('newAccountErrorMsg').value || '',
                status: 'active',
                activationCode: activCode,
                createdAt: new Date().toISOString()
            };
            
            accounts.push(newAccount);
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            
            if (newAccount.balance > 0) {
                addTransaction(newAccount.email, 'credit', newAccount.balance, 'Solde initial');
            }
            
            // Afficher un message avec les informations du compte
            const accountInfo = `
‚úÖ Compte cr√©√© avec succ√®s !

üìß Email: ${newAccount.email}
üîë Mot de passe: ${newAccount.password}
üîê Code d'activation: ${newAccount.activationCode}
üí∞ Solde: ${formatCurrency(newAccount.balance)} ${newAccount.currency}
üìä Progression auto: ${newAccount.autoProgress}%

‚ÑπÔ∏è Ces informations devraient √™tre envoy√©es au client par email.
Pour l'instant, copiez-les et envoyez-les manuellement.
            `;
            
            alert(accountInfo);
            showAlert('createAccountAlert', 'Compte cr√©√© avec succ√®s !', 'success');
            this.reset();
            loadAccountsTable();
            updateDashboard();
            populateAccountSelects();
        });

        function loadAccountsTable() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const tbody = document.getElementById('accountsTableBody');
            
            tbody.innerHTML = accounts.map(acc => {
                const currency = acc.currency || 'GNF';
                const progress = acc.autoProgress !== undefined ? acc.autoProgress : 100;
                const statusColor = acc.status === 'active' ? '#27ae60' : '#e74c3c';
                return `
                    <tr>
                        <td>
                            <div onclick="showAccountDetails(${acc.id})" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                                <div style="width:38px;height:38px;border-radius:50%;background:var(--primary-blue);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0;">
                                    ${acc.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight:600;font-size:14px;">${acc.name}</div>
                                    <div style="font-size:11px;color:#999;">${acc.country || ''} ‚Ä¢ <span style="color:${statusColor}">${acc.status === 'active' ? 'Actif' : 'Bloqu√©'}</span></div>
                                </div>
                            </div>
                        </td>
                        <td class="action-buttons-admin">
                            <button class="btn-small btn-success" onclick="quickRecharge(${acc.id})" title="Recharger">üí∞</button>
                            <button class="btn-small btn-info" onclick="editAccountProgress(${acc.id})" title="Progression">üìä</button>
                            <button class="btn-small btn-warning" onclick="toggleBlockAccount(${acc.id})" title="${acc.status === 'active' ? 'Bloquer' : 'D√©bloquer'}">
                                ${acc.status === 'active' ? 'üîí' : 'üîì'}
                            </button>
                            <button class="btn-small" style="background:#e67e22;color:white;" onclick="resetTransferHistory('${acc.email}')" title="R√©initialiser historique">üîÑ</button>
                            <button class="btn-small btn-danger" onclick="deleteAccount(${acc.id})" title="Supprimer">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function saveFeePercent(accountId) {
            const val = document.getElementById('feePercent_' + accountId)?.value;
            if (val === '' || val === null) { alert('Veuillez entrer un pourcentage'); return; }
            const percent = parseFloat(val);
            if (isNaN(percent) || percent < 0 || percent > 100) { alert('Valeur entre 0 et 100'); return; }
            
            let accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const idx = accounts.findIndex(a => a.id === accountId);
            if (idx === -1) return;
            
            accounts[idx].customFeePercent = percent;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            
            alert('‚úÖ Frais mis √† jour : ' + percent + '% pour ce compte');
            document.getElementById('accountDetailsModal').remove();
            showAccountDetails(accountId);
        }

        function saveLanguage(accountId) {
            const lang = document.getElementById('langSelect_' + accountId)?.value;
            if (!lang) return;
            
            const langNames = { fr:'Fran√ßais', en:'English', ar:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', es:'Espa√±ol', pt:'Portugu√™s', de:'Deutsch', zh:'‰∏≠Êñá' };
            
            let accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const idx = accounts.findIndex(a => a.id === accountId);
            if (idx === -1) return;
            
            accounts[idx].language = lang;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            
            alert('‚úÖ Langue mise √† jour : ' + langNames[lang]);
            document.getElementById('accountDetailsModal').remove();
            showAccountDetails(accountId);
        }

        function saveActivationCode(accountId) {
            const newCode = document.getElementById('editActivationCode_' + accountId)?.value.trim();
            if (!newCode) { alert('Le code ne peut pas √™tre vide'); return; }
            
            let accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const acc = accounts.find(a => a.id === accountId);
            if (!acc) return;
            
            acc.activationCode = newCode;
            acc.activationUsed = false; // R√©initialiser le statut utilis√©
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            
            alert('‚úÖ Code d\'activation mis √† jour !\nNouveau code : ' + newCode);
            document.getElementById('accountDetailsModal').remove();
            showAccountDetails(accountId);
        }

        function showAccountDetails(accountId) {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const acc = accounts.find(a => a.id === accountId);
            if (!acc) return;
            
            const currency = acc.currency || 'GNF';
            const progress = acc.autoProgress !== undefined ? acc.autoProgress : 100;
            const statusLabel = acc.status === 'active' ? '‚úÖ Compte actif' : 'üîí Compte bloqu√©';
            const statusColor = acc.status === 'active' ? '#27ae60' : '#e74c3c';
            const createdAt = acc.createdAt ? new Date(acc.createdAt).toLocaleDateString('fr-FR') : 'N/A';
            
            // Supprimer modal existant
            const existing = document.getElementById('accountDetailsModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'accountDetailsModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:flex-start;justify-content:center;overflow-y:auto;padding:20px;';
            modal.innerHTML = `
                <div style="background:white;border-radius:16px;width:100%;max-width:500px;padding:24px;margin:auto;position:relative;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h3 style="font-size:17px;font-weight:700;margin:0;">D√©tails du compte client</h3>
                        <button onclick="document.getElementById('accountDetailsModal').remove()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#666;">√ó</button>
                    </div>
                    
                    <div style="margin-bottom:18px;">
                        <p style="font-weight:700;color:#333;margin-bottom:12px;font-size:14px;">üë§ Informations sur le client :</p>
                        <div style="background:#f8f9fa;border-radius:12px;padding:16px;">
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Nom Pr√©nom :</strong> ${acc.name}</p>
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Adresse e-mail :</strong> ${acc.email}</p>
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Num√©ro de t√©l√©phone :</strong> ${acc.phone || 'N/A'}</p>
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Pays de r√©sidence :</strong> ${acc.country || 'N/A'}</p>
                            <p style="margin-bottom:10px;font-size:14px;"><strong>Mot de passe :</strong> ${acc.password || 'N/A'}</p>
                            <div style="margin-top:10px;">
                                <p style="margin-bottom:6px;font-size:14px;"><strong>üåê Langue de l'interface :</strong></p>
                                <div style="display:flex;gap:8px;align-items:center;">
                                    <select id="langSelect_${acc.id}" style="flex:1;padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;">
                                        <option value="fr" ${(acc.language||'fr')==='fr'?'selected':''}>üá´üá∑ Fran√ßais</option>
                                        <option value="en" ${acc.language==='en'?'selected':''}>üá¨üáß English</option>
                                        <option value="ar" ${acc.language==='ar'?'selected':''}>üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                                        <option value="es" ${acc.language==='es'?'selected':''}>üá™üá∏ Espa√±ol</option>
                                        <option value="pt" ${acc.language==='pt'?'selected':''}>üáßüá∑ Portugu√™s</option>
                                        <option value="de" ${acc.language==='de'?'selected':''}>üá©üá™ Deutsch</option>
                                        <option value="zh" ${acc.language==='zh'?'selected':''}>üá®üá≥ ‰∏≠Êñá</option>
                                    </select>
                                    <button onclick="saveLanguage(${acc.id})" style="padding:8px 14px;background:#1a73e8;color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">üíæ Sauver</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:18px;">
                        <p style="font-weight:700;color:#333;margin-bottom:12px;font-size:14px;">üè¶ Solde du compte et virement :</p>
                        <div style="background:#f0f8ff;border-radius:12px;padding:12px;margin-bottom:12px;font-size:13px;color:#555;">
                            L'historique des virements est disponible dans la section "Virements".
                        </div>
                        <p style="margin-bottom:10px;font-size:14px;"><strong>Solde du compte :</strong> ${formatCurrency(acc.balance)} ${currency}</p>
                        <p style="margin-bottom:10px;font-size:14px;"><strong>Progression du virement :</strong> <span style="color:${progress===100?'#27ae60':'#e67e22'};font-weight:600;">${progress}%</span></p>
                        <div style="margin-bottom:14px;">
                            <p style="margin-bottom:6px;font-size:14px;"><strong>üí∏ Frais de transaction (%) :</strong></p>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input type="number" id="feePercent_${acc.id}" value="${acc.customFeePercent !== undefined ? acc.customFeePercent : 2}" min="0" max="100" step="0.1"
                                    style="flex:1;padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;" />
                                <button onclick="saveFeePercent(${acc.id})"
                                    style="padding:8px 14px;background:#1a73e8;color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">üíæ Sauver</button>
                            </div>
                            <small style="color:#888;font-size:12px;">Frais appliqu√©s uniquement √† ce compte (remplace le frais global)</small>
                        </div>

                        <p style="margin-bottom:10px;font-size:14px;"><strong>Code d'activation :</strong></p>
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                            <input type="text" id="editActivationCode_${acc.id}" value="${acc.activationCode || ''}" 
                                style="flex:1;padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-family:monospace;font-weight:700;font-size:14px;background:#1a1a2e;color:white;" />
                            <button onclick="saveActivationCode(${acc.id})" 
                                style="padding:8px 14px;background:#27ae60;color:white;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">üíæ Sauver</button>
                        </div>
                        <p style="margin-bottom:10px;font-size:14px;"><strong>Code d√©j√† utilis√© :</strong> 
                            <span style="background:${acc.activationUsed ? '#6f42c1' : '#6c757d'};color:white;padding:4px 12px;border-radius:6px;font-weight:700;font-size:13px;">
                                ${acc.activationUsed ? 'OUI' : 'NON'}
                            </span>
                        </p>
                        <p style="margin-bottom:10px;font-size:14px;"><strong>Message d'erreur :</strong> ${acc.errorMessage || 'N/A'}</p>
                        <p style="margin-bottom:0;font-size:14px;"><strong>Date de cr√©ation :</strong> ${createdAt}</p>
                    </div>

                    <!-- Section Carte Virtuelle -->
                    <div style="margin-bottom:18px;">
                        <p style="font-weight:700;color:#333;margin-bottom:12px;font-size:14px;">üí≥ Carte Virtuelle :</p>
                        <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:18px;border-radius:14px;color:white;margin-bottom:14px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <span style="font-weight:700;font-size:16px;letter-spacing:1px;">VANTEX</span>
                                <span style="font-size:18px;">üí≥</span>
                            </div>
                            <div style="font-size:16px;font-weight:600;letter-spacing:3px;margin-bottom:14px;font-family:'Courier New',monospace;">${acc.virtualCard ? acc.virtualCard.number : '#### #### #### ####'}</div>
                            <div style="display:flex;justify-content:space-between;">
                                <div>
                                    <div style="font-size:9px;opacity:0.7;margin-bottom:2px;">TITULAIRE</div>
                                    <div style="font-size:13px;font-weight:600;">${acc.name.toUpperCase()}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:9px;opacity:0.7;margin-bottom:2px;">EXPIRE FIN</div>
                                    <div style="font-size:13px;font-weight:600;">${acc.virtualCard ? acc.virtualCard.expiration : 'MM/AA'}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:9px;opacity:0.7;margin-bottom:2px;">CVV</div>
                                    <div style="font-size:13px;font-weight:600;">${acc.virtualCard ? acc.virtualCard.cvv : '‚Ä¢‚Ä¢‚Ä¢'}</div>
                                </div>
                            </div>
                        </div>

                        <div style="background:#f8f9fa;border-radius:12px;padding:14px;">
                            <p style="font-size:13px;color:#555;margin-bottom:10px;font-weight:600;">Modifier la carte :</p>
                            <div style="margin-bottom:10px;">
                                <label style="font-size:12px;color:#888;display:block;margin-bottom:4px;">Num√©ro de carte (16 chiffres)</label>
                                <div style="display:flex;gap:6px;align-items:center;">
                                    <input type="text" id="adminCardNumber_${acc.id}" value="${acc.virtualCard ? acc.virtualCard.number : ''}" maxlength="19" placeholder="#### #### #### ####"
                                        style="flex:1;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-family:'Courier New',monospace;font-size:14px;font-weight:600;">
                                    <button onclick="document.getElementById('adminCardNumber_${acc.id}').value=generateCardNumber()" 
                                        style="padding:9px 10px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;">üé≤</button>
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
                                <div>
                                    <label style="font-size:12px;color:#888;display:block;margin-bottom:4px;">Expiration (MM/AA)</label>
                                    <div style="display:flex;gap:6px;align-items:center;">
                                        <input type="text" id="adminCardExp_${acc.id}" value="${acc.virtualCard ? acc.virtualCard.expiration : ''}" maxlength="5" placeholder="MM/AA"
                                            style="flex:1;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;">
                                        <button onclick="document.getElementById('adminCardExp_${acc.id}').value=generateExpirationDate()"
                                            style="padding:9px 10px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;">üé≤</button>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size:12px;color:#888;display:block;margin-bottom:4px;">CVV (3 chiffres)</label>
                                    <div style="display:flex;gap:6px;align-items:center;">
                                        <input type="text" id="adminCardCvv_${acc.id}" value="${acc.virtualCard ? acc.virtualCard.cvv : ''}" maxlength="3" placeholder="‚Ä¢‚Ä¢‚Ä¢"
                                            style="flex:1;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-weight:600;">
                                        <button onclick="document.getElementById('adminCardCvv_${acc.id}').value=generateCVV()"
                                            style="padding:9px 10px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;">üé≤</button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="saveAdminVirtualCard(${acc.id})"
                                style="width:100%;padding:10px;background:#667eea;color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;">
                                üíæ Enregistrer la carte
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align:center;margin-bottom:16px;">
                        <span style="background:${acc.status==='active'?'#d4edda':'#f8d7da'};color:${statusColor};padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;">${statusLabel}</span>
                    </div>
                    
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button onclick="quickRecharge(${acc.id});document.getElementById('accountDetailsModal').remove();" style="flex:1;padding:10px;background:#27ae60;color:white;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;">üí∞ Recharger</button>
                        <button onclick="toggleBlockAccount(${acc.id});document.getElementById('accountDetailsModal').remove();" style="flex:1;padding:10px;background:#f39c12;color:white;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;">${acc.status === 'active' ? 'üîí Bloquer' : 'üîì D√©bloquer'}</button>
                        <button onclick="if(confirm('Supprimer d√©finitivement ?')){deleteAccount(${acc.id});document.getElementById('accountDetailsModal').remove();}" style="flex:1;padding:10px;background:#e74c3c;color:white;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            // Fermer en cliquant dehors
            modal.addEventListener('click', function(e) { if(e.target === modal) modal.remove(); });
        }

        function saveAdminVirtualCard(accountId) {
            const number = document.getElementById('adminCardNumber_' + accountId)?.value.trim();
            const exp    = document.getElementById('adminCardExp_' + accountId)?.value.trim();
            const cvv    = document.getElementById('adminCardCvv_' + accountId)?.value.trim();

            if (!number || number.replace(/\s/g,'').length !== 16) { alert('Le num√©ro doit contenir 16 chiffres'); return; }
            if (!exp || !exp.match(/^\d{2}\/\d{2}$/))              { alert('Format expiration invalide : MM/AA'); return; }
            if (!cvv || cvv.length !== 3)                           { alert('Le CVV doit contenir 3 chiffres'); return; }

            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const acc = accounts.find(a => a.id === accountId);
            if (!acc) return;

            acc.virtualCard = { number, expiration: exp, cvv, updatedAt: new Date().toISOString() };
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));

            // Rafra√Æchir la modal
            document.getElementById('accountDetailsModal').remove();
            showAccountDetails(accountId);
            alert('‚úÖ Carte virtuelle mise √† jour !');
        }

        function editAccountProgress(accountId) {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.id === accountId);
            
            const newProgress = prompt(`Modifier la progression pour ${account.name}\nNouvelle progression (0-100%):`, account.autoProgress || 100);
            
            if (newProgress === null) return;
            
            const progress = parseInt(newProgress);
            if (isNaN(progress) || progress < 0 || progress > 100) {
                alert('La progression doit √™tre entre 0 et 100');
                return;
            }
            
            account.autoProgress = progress;
            
            if (progress < 100) {
                const errorMsg = prompt('Message d\'erreur pour ce compte (si √©chec):');
                account.autoErrorMessage = errorMsg || '';
            }
            
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            loadAccountsTable();
            alert('Progression mise √† jour avec succ√®s !');
        }

        function quickRecharge(accountId) {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.id === accountId);
            const currency = account.currency || 'GNF';
            
            const amount = prompt(`Recharger ${account.name}\nMontant (${currency}):`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                account.balance += parseFloat(amount);
                localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
                addTransaction(account.email, 'credit', parseFloat(amount), 'Virement re√ßu');
                loadAccountsTable();
                updateDashboard();
                alert('Recharge effectu√©e avec succ√®s !');
            }
        }

        function toggleBlockAccount(accountId) {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.id === accountId);
            
            account.status = account.status === 'active' ? 'blocked' : 'active';
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            loadAccountsTable();
            updateDashboard();
        }

        function resetTransferHistory(email) {
            if (!confirm('R√©initialiser le compte de ce client ?\n\n‚ö†Ô∏è Cette action va :\n‚Ä¢ Remettre le solde √† 0\n‚Ä¢ Supprimer tout l\'historique de transactions\n‚Ä¢ Supprimer tout l\'historique de virements')) return;
            
            // Remettre le solde √† z√©ro
            let accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const account = accounts.find(a => a.email === email);
            if (account) {
                account.balance = 0;
                account.activationUsed = false;
                localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            }

            // Supprimer les virements de ce compte
            let transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            transfers = transfers.filter(t => t.accountEmail !== email);
            localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
            
            // Supprimer les transactions de ce compte
            let transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
            transactions = transactions.filter(t => t.accountEmail !== email);
            localStorage.setItem('vantex_transactions', JSON.stringify(transactions));
            
            alert('‚úÖ Compte r√©initialis√© avec succ√®s !\n\n‚Ä¢ Solde remis √† 0\n‚Ä¢ Historique effac√©');
            loadAccountsTable();
            updateDashboard();
            loadTransactionsTable();
            loadTransfersTable();
        }

        async function deleteAccount(accountId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce compte d√©finitivement ?')) return;
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.id === accountId);
            
            if (account) {
                // 1. Marquer comme supprim√© dans Firebase (deleted:true)
                // √áa emp√™che le compte de revenir au rechargement
                try {
                    await db.collection('accounts').doc(accountId.toString()).update({ deleted: true });
                    
                    // Marquer aussi les transactions et virements
                    const snapT = await db.collection('transactions').where('accountEmail', '==', account.email).get();
                    snapT.forEach(doc => doc.ref.update({ deleted: true }));
                    
                    const snapV = await db.collection('transfers').where('accountEmail', '==', account.email).get();
                    snapV.forEach(doc => doc.ref.update({ deleted: true }));
                } catch(e) { console.log('Firebase mark deleted:', e); }
                
                // 2. Supprimer du localStorage imm√©diatement
                let accs = JSON.parse(localStorage.getItem('vantex_accounts'));
                accs = accs.filter(acc => acc.id !== accountId);
                
                let transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
                transfers = transfers.filter(t => t.accountEmail !== account.email);
                
                let transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
                transactions = transactions.filter(t => t.accountEmail !== account.email);
                
                // Sauvegarder sans sync Firebase
                const orig = Storage.prototype.setItem;
                Storage.prototype.setItem.call(localStorage, 'vantex_accounts', JSON.stringify(accs));
                Storage.prototype.setItem.call(localStorage, 'vantex_transfers', JSON.stringify(transfers));
                Storage.prototype.setItem.call(localStorage, 'vantex_transactions', JSON.stringify(transactions));
            }
            
            loadAccountsTable();
            updateDashboard();
            populateAccountSelects();
            alert('‚úÖ Compte supprim√© d√©finitivement !');
        }

        function populateAccountSelects() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const activeAccounts = accounts.filter(acc => acc.status === 'active');
            
            const options = activeAccounts.map(acc => {
                const currency = acc.currency || 'GNF';
                return `<option value="${acc.email}">${acc.name} - ${currency}</option>`;
            }).join('');
            
            document.getElementById('rechargeAccountSelect').innerHTML = 
                '<option value="">-- Choisir un compte --</option>' + options;
            document.getElementById('debitAccountSelect').innerHTML = 
                '<option value="">-- Choisir un compte --</option>' + options;
        }

        document.getElementById('rechargeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('rechargeAccountSelect').value;
            const amount = parseFloat(document.getElementById('rechargeAmount').value);
            const note = document.getElementById('rechargeNote').value;
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === email);
            
            account.balance += amount;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            addTransaction(email, 'credit', amount, note || 'Virement re√ßu');
            
            showAlert('rechargeAlert', 'Recharge effectu√©e avec succ√®s !', 'success');
            this.reset();
            loadAccountsTable();
            updateDashboard();
            loadTransactionsTable();
        });

        // Afficher les frais en temps r√©el dans le formulaire de retrait
        document.getElementById('debitAmount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            if (amount > 0) {
                const fee = amount * 0.02;
                const total = amount + fee;
                document.getElementById('debitFeeInfo').style.display = 'block';
                document.getElementById('debitBaseAmount').textContent = formatCurrency(amount);
                document.getElementById('debitFeeAmount').textContent = formatCurrency(fee);
                document.getElementById('debitTotalAmount').textContent = formatCurrency(total);
            } else {
                document.getElementById('debitFeeInfo').style.display = 'none';
            }
        });

        document.getElementById('debitForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('debitAccountSelect').value;
            const amount = parseFloat(document.getElementById('debitAmount').value);
            const note = document.getElementById('debitNote').value;
            
            // Calculer les frais de 2%
            const fee = amount * 0.02;
            const totalDebit = amount + fee;
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === email);
            
            if (account.balance < totalDebit) {
                showAlert('debitAlert', 'Solde insuffisant ! Total avec frais : ' + formatCurrency(totalDebit), 'error');
                return;
            }
            
            account.balance -= totalDebit;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            addTransaction(email, 'debit', amount, note || 'Retrait');
            addTransaction(email, 'debit', fee, 'Frais de retrait (2%)');
            
            showAlert('debitAlert', 'Retrait effectu√© ! Frais de 2% appliqu√©s : ' + formatCurrency(fee), 'success');
            this.reset();
            document.getElementById('debitFeeInfo').style.display = 'none';
            loadAccountsTable();
            updateDashboard();
            loadTransactionsTable();
        });

        function addTransaction(accountEmail, type, amount, note) {
            const transactions = JSON.parse(localStorage.getItem('vantex_transactions'));
            transactions.push({
                id: Date.now(),
                accountEmail: accountEmail,
                type: type,
                amount: amount,
                note: note,
                date: new Date().toISOString()
            });
            localStorage.setItem('vantex_transactions', JSON.stringify(transactions));
        }

        function loadTransactionsTable() {
            const transactions = JSON.parse(localStorage.getItem('vantex_transactions'));
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const tbody = document.getElementById('transactionsTableBody');
            
            const sorted = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sorted.map(t => {
                const account = accounts.find(acc => acc.email === t.accountEmail);
                const currency = account ? (account.currency || 'GNF') : 'GNF';
                return `
                    <tr>
                        <td>${formatDate(t.date)}</td>
                        <td>${account ? account.name : t.accountEmail}</td>
                        <td><span class="status-badge ${t.type === 'credit' ? 'status-active' : 'status-blocked'}">
                            ${t.type === 'credit' ? 'Cr√©dit' : 'D√©bit'}
                        </span></td>
                        <td>${formatCurrency(t.amount)} ${currency}</td>
                        <td>${t.note || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function saveTransferSettings() {
            const settings = {
                autoProgress: parseInt(document.getElementById('autoProgress').value) || 100,
                autoErrorMessage: document.getElementById('autoErrorMessage').value || ''
            };
            
            localStorage.setItem('vantex_transfer_settings', JSON.stringify(settings));
            alert('Param√®tres enregistr√©s ! Ils s\'appliqueront aux prochains virements.');
        }

        function loadTransferSettings() {
            const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings'));
            document.getElementById('autoProgress').value = settings.autoProgress;
            document.getElementById('autoErrorMessage').value = settings.autoErrorMessage;
        }

        function exportTransfers() {
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            
            let csv = 'Date,Client,Email,Montant,Devise,B√©n√©ficiaire,IBAN,SWIFT,Banque,Raison,Statut\n';
            transfers.forEach(t => {
                const account = accounts.find(acc => acc.email === t.accountEmail);
                csv += `${formatDate(t.date)},${account ? account.name : ''},${t.accountEmail},${t.amount},${t.currency},"${t.beneficiary}","${t.iban}","${t.swift}","${t.bank}","${t.reason}",${t.status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `virements_vantex_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function loadTransfersTable() {
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const tbody = document.getElementById('transfersTableBody');
            
            if (transfers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            Aucun virement n'a √©t√© effectu√©
                        </td>
                    </tr>
                `;
                return;
            }
            
            const sorted = transfers.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sorted.map(t => {
                const account = accounts.find(acc => acc.email === t.accountEmail);
                const statusClass = t.status === 'completed' ? 'status-active' : 
                                   t.status === 'processing' ? 'status-badge' :
                                   t.status === 'failed' ? 'status-blocked' : 'status-badge';
                const statusText = t.status === 'completed' ? 'Compl√©t√©' : 
                                  t.status === 'processing' ? `En traitement (${t.progress || 0}%)` :
                                  t.status === 'failed' ? '√âchou√©' : 'En attente';
                
                return `
                    <tr>
                        <td>${formatDate(t.date)}</td>
                        <td>${account ? account.name : t.accountEmail}</td>
                        <td>${formatCurrency(t.amount)} ${t.currency}</td>
                        <td>${t.beneficiary}</td>
                        <td>${t.iban}</td>
                        <td>${t.bank}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="action-buttons-admin">
                            ${t.status === 'processing' ? `
                                <input type="number" id="progress_${t.id}" min="0" max="100" value="${t.progress || 0}" 
                                    style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" 
                                    placeholder="%">
                                <button class="btn-small btn-info" onclick="updateProgress(${t.id})">üìä Mettre √† jour</button>
                                <button class="btn-small btn-danger" onclick="failTransfer(${t.id})">‚ùå √âchec</button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateProgress(transferId) {
            const progressInput = document.getElementById(`progress_${transferId}`);
            const newProgress = parseInt(progressInput.value);
            
            if (isNaN(newProgress) || newProgress < 0 || newProgress > 100) {
                alert('La progression doit √™tre entre 0 et 100');
                return;
            }
            
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const transfer = transfers.find(t => t.id === transferId);
            
            if (transfer) {
                transfer.progress = newProgress;
                
                // Si la progression atteint 100%, marquer comme compl√©t√©
                if (newProgress === 100) {
                    transfer.status = 'completed';
                }
                
                localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
                loadTransfersTable();
                alert(`Progression mise √† jour: ${newProgress}%`);
            }
        }

        function failTransfer(transferId) {
            const errorMessage = prompt('Message d\'erreur √† afficher au client:');
            
            if (!errorMessage) {
                alert('Veuillez entrer un message d\'erreur');
                return;
            }
            
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const transfer = transfers.find(t => t.id === transferId);
            
            if (transfer) {
                transfer.status = 'failed';
                transfer.errorMessage = errorMessage;
                localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
                
                // Rembourser le client
                const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
                const account = accounts.find(acc => acc.email === transfer.accountEmail);
                if (account) {
                    account.balance += transfer.amount;
                    localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
                    
                    // Ajouter une transaction de remboursement
                    addTransaction(transfer.accountEmail, 'credit', transfer.amount, 'Remboursement: ' + errorMessage);
                }
                
                loadTransfersTable();
                alert('Virement marqu√© comme √©chou√© et client rembours√©');
            }
        }

        function exportTransactions() {
            const transactions = JSON.parse(localStorage.getItem('vantex_transactions'));
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            
            let csv = 'Date,Compte,Email,Type,Montant,Note\n';
            transactions.forEach(t => {
                const account = accounts.find(acc => acc.email === t.accountEmail);
                csv += `${formatDate(t.date)},${account ? account.name : ''},${t.accountEmail},${t.type},${t.amount},"${t.note || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions_vantex_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Cette action supprimera TOUTES les donn√©es (comptes, transactions). Continuer ?')) return;
            if (!confirm('√ätes-vous ABSOLUMENT s√ªr ? Cette action est irr√©versible !')) return;
            
            localStorage.setItem('vantex_accounts', JSON.stringify([]));
            localStorage.setItem('vantex_transactions', JSON.stringify([]));
            
            alert('Toutes les donn√©es ont √©t√© supprim√©es !');
            location.reload();
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR').format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function saveAppSettings() {
            const settings = {
                appName: document.getElementById('appName').value || 'VANTEX',
                defaultCurrency: document.getElementById('defaultCurrency').value.toUpperCase() || 'GNF'
            };
            
            localStorage.setItem('vantex_settings', JSON.stringify(settings));
            showAlert('settingsAlert', 'Param√®tres enregistr√©s avec succ√®s !', 'success');
        }

        function changeAccountCurrency() {
            const accountEmail = document.getElementById('accountCurrencySelect').value;
            const newCurrency = document.getElementById('newCurrencyForAccount').value.trim().toUpperCase();
            
            if (!accountEmail) {
                showAlert('settingsAlert', 'Veuillez s√©lectionner un compte', 'error');
                return;
            }
            
            if (!newCurrency) {
                showAlert('settingsAlert', 'Veuillez entrer une devise', 'error');
                return;
            }
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === accountEmail);
            
            if (account) {
                account.currency = newCurrency;
                localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
                showAlert('settingsAlert', `Devise chang√©e avec succ√®s pour ${account.name} ‚Üí ${newCurrency}`, 'success');
                loadAccountsTable();
                loadTransactionsTable();
                
                // Si le client est connect√©, mettre √† jour son affichage
                if (currentUser && currentUser.email === accountEmail) {
                    updateClientBalance();
                    loadClientTransactions();
                }
            }
        }

        function setQuickCurrencyForAccount(currency) {
            const accountEmail = document.getElementById('accountCurrencySelect').value;
            
            if (!accountEmail) {
                showAlert('settingsAlert', 'Veuillez d\'abord s√©lectionner un compte ci-dessus', 'error');
                return;
            }
            
            document.getElementById('newCurrencyForAccount').value = currency;
            changeAccountCurrency();
        }

        function populateAccountCurrencySelect() {
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const select = document.getElementById('accountCurrencySelect');
            
            if (select) {
                select.innerHTML = '<option value="">-- Choisir un compte --</option>' +
                    accounts.map(acc => 
                        `<option value="${acc.email}">${acc.name} - ${acc.email} (${acc.currency || 'GNF'})</option>`
                    ).join('');
            }
        }

        function loadCurrencySettings() {
            const settings = JSON.parse(localStorage.getItem('vantex_settings'));
            const appNameInput = document.getElementById('appName');
            const defaultCurrencyInput = document.getElementById('defaultCurrency');
            
            if (appNameInput) appNameInput.value = settings.appName;
            if (defaultCurrencyInput) defaultCurrencyInput.value = settings.defaultCurrency;
            
            populateAccountCurrencySelect();
        }

        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type === 'error' ? 'error' : 'success'} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        window.balanceVisible = true;
        window.window.realBalanceText = '';

        window.toggleBalance = function() {
            const balanceEl = document.getElementById('clientBalance');
            const eyeOpen   = document.getElementById('eyeOpenIcon');
            const eyeClosed = document.getElementById('eyeClosedIcon');
            if (!balanceEl) return;
            window.balanceVisible = !window.balanceVisible;

            if (window.balanceVisible) {
                balanceEl.style.filter     = 'none';
                balanceEl.style.opacity    = '1';
                balanceEl.style.transition = 'filter 0.3s ease, opacity 0.3s ease';
                if (eyeOpen)   eyeOpen.style.display   = 'block';
                if (eyeClosed) eyeClosed.style.display = 'none';
            } else {
                balanceEl.style.transition = 'filter 0.3s ease, opacity 0.3s ease';
                balanceEl.style.filter     = 'blur(10px)';
                balanceEl.style.opacity    = '0.4';
                if (eyeOpen)   eyeOpen.style.display   = 'none';
                if (eyeClosed) eyeClosed.style.display = 'block';
            }
        };

        // Surcharger updateClientBalance pour maintenir l'√©tat cach√©
        const _origUpdateClientBalance = window.updateClientBalance;
        window.updateClientBalance = function() {
            if (_origUpdateClientBalance) _origUpdateClientBalance();
            const balanceEl = document.getElementById('clientBalance');
            if (balanceEl && !window.balanceVisible) {
                balanceEl.style.filter  = 'blur(10px)';
                balanceEl.style.opacity = '0.5';
            }
        };
        let currentTransferType = null;

        window.selectTransferType = function(type) {
            currentTransferType = type;
            const cardMobile = document.getElementById('typeCardMobile');
            const cardBank   = document.getElementById('typeCardBank');
            const mobileFields = document.getElementById('mobileFields');
            const bankFields   = document.getElementById('bankFields');

            if (type === 'mobile') {
                cardMobile.style.border = '2px solid #0066CC';
                cardMobile.style.background = '#e8f0fe';
                cardBank.style.border = '2px solid #e0e0e0';
                cardBank.style.background = 'white';
                mobileFields.style.display = 'block';
                bankFields.style.display = 'none';
            } else {
                cardBank.style.border = '2px solid #0066CC';
                cardBank.style.background = '#e8f0fe';
                cardMobile.style.border = '2px solid #e0e0e0';
                cardMobile.style.background = 'white';
                bankFields.style.display = 'block';
                mobileFields.style.display = 'none';
            }
        };

        // R√©initialiser le type quand on ouvre le formulaire
        const _origOpenTransferModal2 = window.openTransferModal;
        window.openTransferModal = function() {
            currentTransferType = null;
            document.getElementById('typeCardMobile').style.border = '2px solid #e0e0e0';
            document.getElementById('typeCardMobile').style.background = 'white';
            document.getElementById('typeCardBank').style.border = '2px solid #e0e0e0';
            document.getElementById('typeCardBank').style.background = 'white';
            document.getElementById('mobileFields').style.display = 'none';
            document.getElementById('bankFields').style.display = 'none';
            if (_origOpenTransferModal2) _origOpenTransferModal2();
        };

        // Overrider la soumission pour valider selon le type choisi
        document.getElementById('transferForm').addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopImmediatePropagation();

            if (!currentTransferType) {
                alert('Veuillez choisir un type de transfert : Mobile ou Bancaire');
                return;
            }

            const amount = parseFloat(document.getElementById('transferAmount').value);
            const beneficiary = document.getElementById('transferBeneficiary').value.trim();
            const reason = document.getElementById('transferReason').value.trim();
            const currency = currentUser ? (currentUser.currency || 'GNF') : 'GNF';

            if (!amount || amount <= 0) { alert('Veuillez entrer un montant valide'); return; }
            if (!beneficiary) { alert('Veuillez entrer le nom du b√©n√©ficiaire'); return; }
            if (!reason) { alert('Veuillez entrer la raison du virement'); return; }

            let iban = '', swift = '', bank = '';

            if (currentTransferType === 'mobile') {
                const operator = document.getElementById('transferOperator').value;
                const mobileNum = document.getElementById('transferMobileNumber').value.trim();
                const mobileCountry = document.getElementById('transferMobileCountry').value;
                if (!operator)     { alert('Veuillez choisir un op√©rateur mobile'); return; }
                if (!mobileNum)    { alert('Veuillez entrer le num√©ro Mobile Money'); return; }
                if (!mobileCountry){ alert('Veuillez choisir le pays'); return; }
                iban  = mobileNum;
                swift = operator;
                bank  = 'Mobile Money ‚Äì ' + mobileCountry;
            } else {
                iban  = document.getElementById('transferIban').value.trim();
                swift = document.getElementById('transferSwift').value.trim();
                bank  = document.getElementById('transferBank').value.trim();
                if (!iban)  { alert('Veuillez entrer l\'IBAN / Num√©ro de compte'); return; }
                if (!swift) { alert('Veuillez entrer le code BIC / SWIFT'); return; }
                if (!bank)  { alert('Veuillez entrer le nom de la banque'); return; }
            }

            const settingsData = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
            const allAccounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const myAcct = allAccounts.find(a => a.email === currentUser.email);
            const clientFeePercent = (myAcct && myAcct.customFeePercent !== undefined)
                ? myAcct.customFeePercent
                : (settingsData.clientFeePercent !== undefined ? settingsData.clientFeePercent : 2);
            const fee = amount * (clientFeePercent / 100);
            const totalAmount = amount + fee;

            // V√©rifier solde suffisant avant confirmation
            const accts1 = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const acct1 = accts1.find(a => a.email === currentUser.email);
            if (acct1 && acct1.balance < totalAmount) {
                alert('‚ùå Solde insuffisant !\n\nMontant : ' + amount.toLocaleString('fr-FR') + ' ' + currency +
                      '\nFrais : ' + fee.toLocaleString('fr-FR') + ' ' + currency +
                      '\nTotal n√©cessaire : ' + totalAmount.toLocaleString('fr-FR') + ' ' + currency +
                      '\nVotre solde : ' + acct1.balance.toLocaleString('fr-FR') + ' ' + currency);
                return;
            }

            // R√©cup√©rer infos mobile si applicable
            const _operator = currentTransferType === 'mobile' ? (document.getElementById('transferOperator')?.value || '') : '';
            const _mobileNum = currentTransferType === 'mobile' ? (document.getElementById('transferMobileNumber')?.value?.trim() || '') : '';
            const _mobileCountry = currentTransferType === 'mobile' ? (document.getElementById('transferMobileCountry')?.value || '') : '';

            pendingTransferData = {
                amount, fee, totalAmount,
                beneficiary, iban, swift, bank, reason, currency,
                transferType: currentTransferType,
                operator: _operator,
                mobileNumber: _mobileNum,
                mobileCountry: _mobileCountry
            };

            document.getElementById('transferModal').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'none';
            document.getElementById('transferConfirmation').style.display = 'block';

            // Label selon type
            const typeLabel = currentTransferType === 'mobile' ? 'üì± ' + swift : 'üè¶ ' + bank;
            document.getElementById('confirmAmount').textContent = formatCurrency(amount) + ' ' + currency;
            document.getElementById('confirmBeneficiary').textContent = beneficiary;
            document.getElementById('confirmIban').textContent = iban;
            document.getElementById('confirmSwift').textContent = swift;
            document.getElementById('confirmBank').textContent = typeLabel;
            document.getElementById('confirmReason').textContent = reason;

            const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('userAvatarConfirm').textContent = initials;
        }, true);

        // Afficher les frais en temps r√©el c√¥t√© client
        document.getElementById('transferAmount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            if (amount > 0) {
                const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
                const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
                const myAccount = accounts.find(a => a.email === currentUser.email);
                // Frais individuel du compte prioritaire sur le frais global
                const feePercent = (myAccount && myAccount.customFeePercent !== undefined) 
                    ? myAccount.customFeePercent 
                    : (settings.clientFeePercent !== undefined ? settings.clientFeePercent : 2);
                const fee = amount * (feePercent / 100);
                const total = amount + fee;
                const currency = currentUser ? currentUser.currency || 'GNF' : 'GNF';
                document.getElementById('clientFeeInfo').style.display = 'block';
                document.getElementById('clientBaseAmount').textContent = formatCurrency(amount) + ' ' + currency;
                document.getElementById('clientFeeAmount').textContent = formatCurrency(fee) + ' ' + currency + ' (' + feePercent + '%)';
                document.getElementById('clientTotalAmount').textContent = formatCurrency(total) + ' ' + currency;
            } else {
                document.getElementById('clientFeeInfo').style.display = 'none';
            }
        });

        // Listener pour le formulaire de virement
        document.getElementById('transferForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const beneficiary = document.getElementById('transferBeneficiary').value.trim();
            const iban = document.getElementById('transferIban').value.trim();
            const swift = document.getElementById('transferSwift').value.trim();
            const bank = document.getElementById('transferBank').value.trim();
            const reason = document.getElementById('transferReason').value.trim();
            const currency = currentUser.currency || 'GNF';

            if (!amount || amount <= 0) {
                alert('Veuillez entrer un montant valide');
                return;
            }

            const settingsData = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
            const allAccounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const myAcct = allAccounts.find(a => a.email === currentUser.email);
            // Frais individuel prioritaire sur frais global
            const clientFeePercent = (myAcct && myAcct.customFeePercent !== undefined)
                ? myAcct.customFeePercent
                : (settingsData.clientFeePercent !== undefined ? settingsData.clientFeePercent : 2);
            const fee = amount * (clientFeePercent / 100);
            const totalAmount = amount + fee;

            // V√©rifier solde suffisant avant confirmation
            const accts2 = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const acct2 = accts2.find(a => a.email === currentUser.email);
            if (acct2 && acct2.balance < totalAmount) {
                alert('‚ùå Solde insuffisant !\n\nMontant : ' + amount.toLocaleString('fr-FR') + ' ' + currency +
                      '\nFrais : ' + fee.toLocaleString('fr-FR') + ' ' + currency +
                      '\nTotal n√©cessaire : ' + totalAmount.toLocaleString('fr-FR') + ' ' + currency +
                      '\nVotre solde : ' + acct2.balance.toLocaleString('fr-FR') + ' ' + currency);
                return;
            }

            pendingTransferData = {
                amount: amount,
                fee: fee,
                totalAmount: totalAmount,
                beneficiary: beneficiary,
                iban: iban,
                swift: swift,
                bank: bank,
                reason: reason,
                currency: currency
            };

            // Afficher la page de confirmation
            document.getElementById('transferModal').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'none';
            document.getElementById('transferConfirmation').style.display = 'block';

            // Remplir les d√©tails
            document.getElementById('confirmAmount').textContent = formatCurrency(amount) + ' ' + currency;
            document.getElementById('confirmBeneficiary').textContent = beneficiary;
            document.getElementById('confirmIban').textContent = iban;
            document.getElementById('confirmSwift').textContent = swift;
            document.getElementById('confirmBank').textContent = bank;
            document.getElementById('confirmReason').textContent = reason;

            // Avatar
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('userAvatarConfirm').textContent = initials;
        });

        function showIban() {
            alert('Fonctionnalit√© IBAN √† venir');
        }

        function openTransferModal() {
            document.getElementById('transferModal').style.display = 'block';
            // Mettre √† jour le solde dans le header du modal
            if (window.currentUser) {
                const currency = window.currentUser.currency || 'GNF';
                const balance = window.currentUser.balance || 0;
                const hb = document.getElementById('headerBalance');
                if (hb) hb.textContent = balance.toLocaleString('fr-FR') + ' ' + currency;
            }
            document.getElementById('clientInterface').style.display = 'none';
            // Mettre √† jour le solde affich√©
            if (currentUser) {
                const currency = currentUser.currency || 'GNF';
                const balanceEl = document.getElementById('transferAvailableBalance');
                if (balanceEl) balanceEl.textContent = formatCurrency(currentUser.balance) + ' ' + currency;
                const currencyEl = document.getElementById('transferCurrency');
                if (currencyEl) currencyEl.value = currency;
            }
        }

        function closeTransferPage() {
            document.getElementById('transferModal').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'block';
            document.getElementById('transferForm').reset();
        }

        function showTransferConfirmation() {
            // Masquer la page de virement
            document.getElementById('transferModal').style.display = 'none';
            
            // Masquer l'interface client normale
            document.getElementById('clientInterface').style.display = 'none';
            
            // Afficher la page de confirmation
            document.getElementById('transferConfirmation').style.display = 'block';
            
            // Remplir les d√©tails
            const currency = pendingTransferData.currency;
            document.getElementById('confirmAmount').textContent = 
                formatCurrency(pendingTransferData.amount) + ' ' + currency;
            document.getElementById('confirmBeneficiary').textContent = pendingTransferData.beneficiary;
            document.getElementById('confirmIban').textContent = pendingTransferData.iban;
            document.getElementById('confirmSwift').textContent = pendingTransferData.swift;
            document.getElementById('confirmBank').textContent = pendingTransferData.bank;
            document.getElementById('confirmReason').textContent = pendingTransferData.reason;
            
            // Mettre √† jour l'avatar
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            document.getElementById('userAvatarConfirm').textContent = initials;
        }

        function cancelTransferProcess() {
            if (confirm('√ätes-vous s√ªr de vouloir annuler ce virement ?')) {
                pendingTransferData = null;
                document.getElementById('activationCode').value = '';
                backToClientDashboard();
            }
        }

        function backToClientDashboard() {
            document.getElementById('transferConfirmation').style.display = 'none';
            document.getElementById('transferProcessing').style.display = 'none';
            document.getElementById('transferModal').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'block';
            document.getElementById('transferForm').reset();
            pendingTransferData = null;
        }

        function processTransfer() {
            const activationCode = document.getElementById('activationCode').value.trim();
            
            if (!activationCode) {
                alert('Veuillez entrer le code d\'activation');
                return;
            }
            
            // V√©rifier que le code correspond au code unique du compte
            const allAccts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
            const userAcct = allAccts.find(acc => acc.email === currentUser.email);
            if (!userAcct || userAcct.activationCode !== activationCode) {
                alert('‚ùå Code d\'activation incorrect. Veuillez contacter l\'administrateur.');
                return;
            }
            
            // V√©rifier solde suffisant (montant + frais)
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === currentUser.email);
            const totalToDebit = pendingTransferData.totalAmount || (pendingTransferData.amount + (pendingTransferData.fee || 0));
            
            if (account.balance < totalToDebit) {
                const currency = pendingTransferData.currency || '';
                alert('‚ùå Solde insuffisant !\n\nMontant : ' + (pendingTransferData.amount || 0).toLocaleString('fr-FR') + ' ' + currency +
                      '\nFrais : ' + (pendingTransferData.fee || 0).toLocaleString('fr-FR') + ' ' + currency +
                      '\nTotal n√©cessaire : ' + totalToDebit.toLocaleString('fr-FR') + ' ' + currency +
                      '\nVotre solde : ' + account.balance.toLocaleString('fr-FR') + ' ' + currency);
                return;
            }
            
            // D√©biter le montant + frais
            account.balance -= totalToDebit;
            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            currentUser.balance = account.balance;
            
            // Enregistrer la transaction principale (d√©bit montant)
            const transferNote = `Virement √† ${pendingTransferData.beneficiary} (${pendingTransferData.bank})`;
            addTransaction(currentUser.email, 'debit', pendingTransferData.amount, transferNote);
            
            // Enregistrer les frais s√©par√©ment si > 0
            if (pendingTransferData.fee && pendingTransferData.fee > 0) {
                addTransaction(currentUser.email, 'debit', pendingTransferData.fee, 'üí∏ Frais de transaction');
            }
            
            // Enregistrer les d√©tails du virement avec code d'activation
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const transferId = Date.now();
            transfers.push({
                id: transferId,
                accountEmail: currentUser.email,
                amount: pendingTransferData.amount,
                fee: pendingTransferData.fee || 0,
                currency: pendingTransferData.currency,
                beneficiary: pendingTransferData.beneficiary,
                iban: pendingTransferData.iban,
                swift: pendingTransferData.swift,
                bank: pendingTransferData.bank,
                reason: pendingTransferData.reason,
                transferType: pendingTransferData.transferType || 'bank',
                operator: pendingTransferData.operator || '',
                mobileNumber: pendingTransferData.mobileNumber || '',
                mobileCountry: pendingTransferData.mobileCountry || '',
                activationCode: activationCode,
                date: new Date().toISOString(),
                status: 'processing',
                progress: 0,
                errorMessage: null
            });
            localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
            
            // Passer √† l'√©cran de traitement
            document.getElementById('transferConfirmation').style.display = 'none';
            document.getElementById('transferProcessing').style.display = 'block';
            
            // Remplir les d√©tails sur la page de traitement
            const currency = pendingTransferData.currency;
            document.getElementById('processingAmount').textContent = 
                formatCurrency(pendingTransferData.amount) + ' ' + currency;
            document.getElementById('processingBeneficiary').textContent = pendingTransferData.beneficiary;
            document.getElementById('processingIban').textContent = pendingTransferData.iban;
            document.getElementById('processingBank').textContent = pendingTransferData.bank;
            
            // D√©marrer la surveillance de la progression
            startProgressMonitoring(transferId);
        }

        let progressInterval = null;
        
        function startProgressMonitoring(transferId) {
            // R√©initialiser l'affichage
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            
            // R√©cup√©rer les param√®tres du compte sp√©cifique
            const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
            const transfer = transfers.find(t => t.id === transferId);
            
            if (!transfer) return;
            
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            const account = accounts.find(acc => acc.email === transfer.accountEmail);
            
            const targetProgress = account.autoProgress !== undefined ? account.autoProgress : 100;
            const errorMessage = account.autoErrorMessage || 'Une erreur est survenue';
            
            let currentProgress = 0;
            
            // Incr√©menter progressivement de 1% toutes les 2-3 secondes
            const progressTimer = setInterval(() => {
                if (currentProgress < targetProgress) {
                    currentProgress++;
                    transfer.progress = currentProgress;
                    localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
                } else {
                    clearInterval(progressTimer);
                    
                    // Marquer comme compl√©t√© ou √©chou√©
                    if (targetProgress === 100) {
                        transfer.status = 'completed';
                    } else {
                        transfer.status = 'failed';
                        transfer.errorMessage = errorMessage;
                        
                        // Rembourser le client
                        const account = accounts.find(acc => acc.email === transfer.accountEmail);
                        if (account) {
                            account.balance += transfer.amount;
                            localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
                            addTransaction(transfer.accountEmail, 'credit', transfer.amount, 'Remboursement: ' + errorMessage);
                        }
                    }
                    
                    localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
                }
            }, 2500); // 2.5 secondes entre chaque pourcentage
            
            // V√©rifier et afficher la progression toutes les 500ms
            progressInterval = setInterval(() => {
                const updatedTransfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
                const updatedTransfer = updatedTransfers.find(t => t.id === transferId);
                
                if (updatedTransfer) {
                    const progress = updatedTransfer.progress || 0;
                    
                    // Mettre √† jour la barre de progression
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = progress + '%';
                    
                    // V√©rifier si le virement est termin√©
                    if (updatedTransfer.status === 'completed' && progress === 100) {
                        clearInterval(progressInterval);
                        clearInterval(progressTimer);
                        document.getElementById('successMessage').style.display = 'block';
                    } else if (updatedTransfer.status === 'failed') {
                        clearInterval(progressInterval);
                        clearInterval(progressTimer);
                        document.getElementById('errorMessage').style.display = 'block';
                        document.getElementById('errorText').textContent = updatedTransfer.errorMessage || 'Une erreur est survenue lors du traitement';
                    }
                }
            }, 500);
        }

        function showVirtualCard() {
            alert('Fonctionnalit√© Carte Virtuelle √† venir');
        }

        // Initialize
        if (localStorage.getItem('vantex_accounts') === '[]') {
            // Create demo account
            const demoAccount = {
                id: Date.now(),
                lastName: 'KARAMO',
                firstName: 'FOFANA',
                name: 'FOFANA KARAMO',
                email: 'demo@vantex.com',
                phone: '+224 123 456 789',
                country: 'Guin√©e',
                password: 'demo123',
                balance: 0,
                currency: 'GNF',
                autoProgress: 100,
                autoErrorMessage: '',
                status: 'active',
                createdAt: new Date().toISOString()
            };
            localStorage.setItem('vantex_accounts', JSON.stringify([demoAccount]));
        } else {
            // Ajouter les nouveaux champs aux comptes existants
            const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
            let updated = false;
            accounts.forEach(acc => {
                if (!acc.currency) {
                    acc.currency = 'GNF';
                    updated = true;
                }
                if (acc.autoProgress === undefined) {
                    acc.autoProgress = 100;
                    updated = true;
                }
                if (!acc.autoErrorMessage) {
                    acc.autoErrorMessage = '';
                    updated = true;
                }
                if (!acc.country) {
                    acc.country = '';
                    updated = true;
                }
                if (!acc.firstName && acc.name) {
                    const nameParts = acc.name.split(' ');
                    acc.firstName = nameParts[0] || '';
                    acc.lastName = nameParts.slice(1).join(' ') || '';
                    updated = true;
                }
            });
            if (updated) {
                localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
            }
        }
   script>
// ============================================
// MODULE FRAIS DE TRANSACTION - VANTEX
// ============================================
(function() {
    // Initialiser les frais dans les settings
    const existingSettings = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
    if (!existingSettings.transactionFeePercent) {
        existingSettings.transactionFeePercent = 2;
        localStorage.setItem('vantex_transfer_settings', JSON.stringify(existingSettings));
    }
})();

// OVERRIDE saveTransferSettings
window.saveTransferSettings = function() {
    const settings = {
        autoProgress: parseInt(document.getElementById('autoProgress').value) || 100,
        autoErrorMessage: document.getElementById('autoErrorMessage').value || '',
        transactionFeePercent: parseFloat(document.getElementById('transactionFeePercent')?.value) || 0,
        clientFeePercent: parseFloat(document.getElementById('clientFeePercent')?.value) || 0
    };
    
    localStorage.setItem('vantex_transfer_settings', JSON.stringify(settings));
    alert('‚úÖ Param√®tres enregistr√©s !\n\nFrais de transaction : ' + settings.transactionFeePercent + '%\nCes param√®tres s\'appliqueront aux prochains virements.');
};

// OVERRIDE loadTransferSettings
const originalLoadTransferSettings = window.loadTransferSettings;
window.loadTransferSettings = function() {
    if (originalLoadTransferSettings) originalLoadTransferSettings();
    const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings') || '{}');
    const feeInput = document.getElementById('transactionFeePercent');
    if (feeInput) feeInput.value = settings.transactionFeePercent || 2;
    const clientFeeInput = document.getElementById('clientFeePercent');
    if (clientFeeInput) clientFeeInput.value = settings.clientFeePercent !== undefined ? settings.clientFeePercent : 2;
};

// OVERRIDE openTransferModal
const originalOpenTransferModal = window.openTransferModal;
window.openTransferModal = function() {
    if (originalOpenTransferModal) originalOpenTransferModal();
    // Fermer si ouvert comme modal classique
    const modal = document.getElementById('transferModal');
    if (modal) { modal.style.display = 'block'; }
    const ci = document.getElementById('clientInterface');
    if (ci) { ci.style.display = 'none'; }
    
    setTimeout(function() {
        const amountInput = document.getElementById('transferAmount');
        if (amountInput) {
            const newInput = amountInput.cloneNode(true);
            amountInput.parentNode.replaceChild(newInput, amountInput);
            
            newInput.addEventListener('input', function() {
                const amount = parseFloat(this.value) || 0;
                
                if (amount > 0 && window.currentUser) {
                    const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings'));
                    const feePercent = settings.transactionFeePercent || 0;
                    const feeAmount = (amount * feePercent) / 100;
                    const totalAmount = amount + feeAmount;
                    const currency = window.currentUser.currency || 'GNF';
                    
                    let feeCalc = document.getElementById('feeCalculation');
                    if (!feeCalc) {
                        const balanceDiv = document.getElementById('transferAvailableBalance')?.parentElement;
                        if (balanceDiv) {
                            feeCalc = document.createElement('div');
                            feeCalc.id = 'feeCalculation';
                            feeCalc.style.cssText = 'display: none; padding-top: 12px; border-top: 1px solid #d0e8ff; margin-top: 12px;';
                            feeCalc.innerHTML = `
                                <p style="margin: 4px 0; color: #666; font-size: 13px;">
                                    <strong>Montant du virement:</strong> <span id="transferBaseAmount">0.00</span>
                                </p>
                                <p style="margin: 4px 0; color: #666; font-size: 13px;">
                                    <strong>Frais (<span id="feePercentDisplay">0</span>%):</strong> <span id="transferFeeAmount">0.00</span>
                                </p>
                                <p style="margin: 8px 0 4px 0; color: var(--primary-blue); font-size: 15px; font-weight: 700;">
                                    <strong>üí∞ TOTAL √Ä D√âBITER:</strong> <span id="transferTotalAmount">0.00</span>
                                </p>
                            `;
                            balanceDiv.appendChild(feeCalc);
                        }
                    }
                    
                    if (feeCalc) {
                        feeCalc.style.display = 'block';
                        document.getElementById('feePercentDisplay').textContent = feePercent;
                        document.getElementById('transferBaseAmount').textContent = window.formatCurrency(amount) + ' ' + currency;
                        document.getElementById('transferFeeAmount').textContent = window.formatCurrency(feeAmount) + ' ' + currency;
                        document.getElementById('transferTotalAmount').textContent = window.formatCurrency(totalAmount) + ' ' + currency;
                    }
                } else {
                    const feeCalc = document.getElementById('feeCalculation');
                    if (feeCalc) feeCalc.style.display = 'none';
                }
            });
        }
    }, 200);
};

// OVERRIDE showTransferConfirmation
const originalShowTransferConfirmation = window.showTransferConfirmation;
window.showTransferConfirmation = function() {
    if (originalShowTransferConfirmation) originalShowTransferConfirmation();
    
    if (window.pendingTransferData) {
        const currency = window.pendingTransferData.currency;
        const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings'));
        const feePercent = settings.transactionFeePercent || 0;
        const feeAmount = (window.pendingTransferData.amount * feePercent) / 100;
        const totalAmount = window.pendingTransferData.amount + feeAmount;
        
        let amountDisplay = window.formatCurrency(window.pendingTransferData.amount) + ' ' + currency;
        if (feeAmount > 0) {
            amountDisplay += '<br><small style="color: #666; font-size: 14px;">+ Frais (' + feePercent + '%) : ' + 
                             window.formatCurrency(feeAmount) + ' ' + currency + '</small>' +
                             '<br><strong style="color: var(--primary-blue); font-size: 22px;">Total : ' + 
                             window.formatCurrency(totalAmount) + ' ' + currency + '</strong>';
        }
        
        const confirmAmountEl = document.getElementById('confirmAmount');
        if (confirmAmountEl) {
            confirmAmountEl.innerHTML = amountDisplay;
        }
    }
};

// OVERRIDE processTransfer
const originalProcessTransfer = window.processTransfer;
window.processTransfer = function() {
    const activationCode = document.getElementById('activationCode').value.trim();
    
    if (!activationCode) {
        alert('Veuillez entrer le code d\'activation');
        return;
    }
    
    if (!window.pendingTransferData || !window.currentUser) {
        alert('Erreur: Donn√©es du virement manquantes');
        return;
    }
    
    // V√©rifier que le code correspond au code unique du compte
    const allAccts2 = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
    const userAcct2 = allAccts2.find(acc => acc.email === window.currentUser.email);
    if (!userAcct2 || userAcct2.activationCode !== activationCode) {
        alert('‚ùå Code d\'activation incorrect. Veuillez contacter l\'administrateur.');
        return;
    }
    
    // Marquer le code comme utilis√© (OUI dans la popup admin)
    const allAccs = JSON.parse(localStorage.getItem('vantex_accounts'));
    const accIndex = allAccs.findIndex(a => a.email === window.currentUser.email);
    if (accIndex !== -1) {
        allAccs[accIndex].activationUsed = true;
        localStorage.setItem('vantex_accounts', JSON.stringify(allAccs));
    }
    
    const settings = JSON.parse(localStorage.getItem('vantex_transfer_settings'));
    const feePercent = settings.transactionFeePercent || 0;
    const feeAmount = (window.pendingTransferData.amount * feePercent) / 100;
    const totalAmount = window.pendingTransferData.amount + feeAmount;
    
    if (window.currentUser.balance < totalAmount) {
        alert('Solde insuffisant !\nVous avez besoin de ' + window.formatCurrency(totalAmount) + ' ' + (window.currentUser.currency || 'GNF') + ' (montant + frais)');
        return;
    }
    
    const accounts = JSON.parse(localStorage.getItem('vantex_accounts'));
    const account = accounts.find(acc => acc.email === window.currentUser.email);
    account.balance -= totalAmount;
    localStorage.setItem('vantex_accounts', JSON.stringify(accounts));
    
    const transferNote = `Virement √† ${window.pendingTransferData.beneficiary} (${window.pendingTransferData.bank})`;
    window.addTransaction(window.currentUser.email, 'debit', window.pendingTransferData.amount, transferNote);
    
    if (feeAmount > 0) {
        window.addTransaction(window.currentUser.email, 'debit', feeAmount, 'Frais de virement (' + feePercent + '%)');
    }
    
    const transfers = JSON.parse(localStorage.getItem('vantex_transfers') || '[]');
    const transferId = Date.now();
    transfers.push({
        id: transferId,
        accountEmail: window.currentUser.email,
        amount: window.pendingTransferData.amount,
        feeAmount: feeAmount,
        feePercent: feePercent,
        totalAmount: totalAmount,
        currency: window.pendingTransferData.currency,
        beneficiary: window.pendingTransferData.beneficiary,
        iban: window.pendingTransferData.iban,
        swift: window.pendingTransferData.swift,
        bank: window.pendingTransferData.bank,
        reason: window.pendingTransferData.reason,
        activationCode: activationCode,
        date: new Date().toISOString(),
        status: 'processing',
        progress: 0,
        errorMessage: null
    });
    localStorage.setItem('vantex_transfers', JSON.stringify(transfers));
    
    document.getElementById('transferConfirmation').style.display = 'none';
    document.getElementById('transferProcessing').style.display = 'block';
    
    const currency = window.pendingTransferData.currency;
    document.getElementById('processingAmount').textContent = window.formatCurrency(window.pendingTransferData.amount) + ' ' + currency;
    document.getElementById('processingBeneficiary').textContent = window.pendingTransferData.beneficiary;
    document.getElementById('processingIban').textContent = window.pendingTransferData.iban;
    document.getElementById('processingBank').textContent = window.pendingTransferData.bank;
    
    window.startProgressMonitoring(transferId);
};

console.log('‚úÖ Module Frais de Transaction charg√©');
console.log('üí∞ Frais: ' + (JSON.parse(localStorage.getItem('vantex_transfer_settings')).transactionFeePercent || 2) + '%');

// ============================================
// MODULE NOTIFICATIONS - VANTEX
// ============================================

if (!localStorage.getItem('vantex_notifications')) {
    localStorage.setItem('vantex_notifications', JSON.stringify([]));
}

// Couleurs par type
const notifColors = {
    info:    { bg: '#e0f0ff', border: '#2196F3', color: '#0d47a1', icon: '‚ÑπÔ∏è' },
    success: { bg: '#e8f5e9', border: '#4CAF50', color: '#1b5e20', icon: '‚úÖ' },
    warning: { bg: '#fff8e1', border: '#FFC107', color: '#7B4F00', icon: '‚ö†Ô∏è' },
    danger:  { bg: '#ffebee', border: '#f44336', color: '#b71c1c', icon: '‚ùå' }
};

// ---- ADMIN : cr√©er une notification ----
window.createNotification = function() {
    const accountEmail = document.getElementById('notifAccountSelect').value;
    const message = document.getElementById('notifMessage').value.trim();
    const type = document.getElementById('notifType').value;

    if (!accountEmail) { alert('Veuillez s√©lectionner un compte'); return; }
    if (!message)       { alert('Veuillez √©crire un message'); return; }

    const notifications = JSON.parse(localStorage.getItem('vantex_notifications') || '[]');
    notifications.push({
        id: Date.now(),
        accountEmail: accountEmail,
        message: message,
        type: type,
        date: new Date().toISOString(),
        active: true
    });
    localStorage.setItem('vantex_notifications', JSON.stringify(notifications));

    document.getElementById('notifMessage').value = '';
    alert('‚úÖ Notification envoy√©e avec succ√®s !');
    window.loadNotificationsTable();
};

// ---- ADMIN : supprimer une notification ----
window.deleteNotification = function(id) {
    let notifications = JSON.parse(localStorage.getItem('vantex_notifications') || '[]');
    notifications = notifications.filter(n => n.id !== id);
    localStorage.setItem('vantex_notifications', JSON.stringify(notifications));
    window.loadNotificationsTable();
};

// ---- ADMIN : supprimer toutes les notifications ----
window.clearAllNotifications = function() {
    if (!confirm('Supprimer toutes les notifications actives ?')) return;
    localStorage.setItem('vantex_notifications', JSON.stringify([]));
    window.loadNotificationsTable();
    alert('‚úÖ Toutes les notifications ont √©t√© supprim√©es.');
};

// ---- ADMIN : charger la table des notifications ----
window.loadNotificationsTable = function() {
    const notifications = JSON.parse(localStorage.getItem('vantex_notifications') || '[]');
    const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
    const tbody = document.getElementById('notificationsTableBody');
    if (!tbody) return;

    if (notifications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:#999;">Aucune notification active</td></tr>';
        return;
    }

    const sorted = [...notifications].sort((a, b) => new Date(b.date) - new Date(a.date));
    tbody.innerHTML = sorted.map(n => {
        const c = notifColors[n.type] || notifColors.info;
        const account = accounts.find(a => a.email === n.accountEmail);
        const clientName = n.accountEmail === 'ALL' ? 'üì¢ Tous les comptes' : (account ? account.name : n.accountEmail);
        return `
            <tr>
                <td><strong>${clientName}</strong></td>
                <td><span style="background:${c.bg};color:${c.color};padding:4px 10px;border-radius:10px;font-size:12px;font-weight:600;">${c.icon} ${n.type}</span></td>
                <td>${n.message}</td>
                <td style="font-size:12px;color:#999;">${new Date(n.date).toLocaleString('fr-FR')}</td>
                <td><button onclick="deleteNotification(${n.id})" class="btn-small btn-danger">üóëÔ∏è</button></td>
            </tr>
        `;
    }).join('');
};

// ---- ADMIN : peupler le select comptes dans l'onglet notifications ----
window.populateNotifAccountSelect = function() {
    const accounts = JSON.parse(localStorage.getItem('vantex_accounts') || '[]');
    const select = document.getElementById('notifAccountSelect');
    if (!select) return;
    select.innerHTML = '<option value="">-- Choisir un compte --</option><option value="ALL">üì¢ Tous les comptes</option>' +
        accounts.map(acc => `<option value="${acc.email}">${acc.name} ‚Äî ${acc.email}</option>`).join('');
};

// ---- CLIENT : boucle d'affichage des notifications ----
let notifLoopInterval = null;

function startClientNotifLoop() {
    if (notifLoopInterval) clearInterval(notifLoopInterval);
    window._notifIndex = 0;

    function showNextNotif() {
        if (!window.currentUser) return;
        const notifications = JSON.parse(localStorage.getItem('vantex_notifications') || '[]');
        const myNotifs = notifications.filter(n => n.active && (n.accountEmail === currentUser.email || n.accountEmail === 'ALL'));

        const banner = document.getElementById('clientNotifBanner');
        if (!banner) return;

        if (myNotifs.length === 0) {
            banner.style.display = 'none';
            return;
        }

        if (window._notifIndex >= myNotifs.length) window._notifIndex = 0;
        const notif = myNotifs[window._notifIndex];
        window._notifIndex++;

        const c = notifColors[notif.type] || notifColors.info;

        // Afficher
        banner.style.cssText = `display:block; margin:0 12px 8px; border-radius:12px; padding:13px 16px; font-size:14px; font-weight:600; background:${c.bg}; border-left:4px solid ${c.border}; color:${c.color}; transition:opacity 0.4s ease;`;
        banner.innerHTML = `<span>${c.icon}&nbsp;&nbsp;${notif.message}</span>`;
        banner.style.opacity = '1';

        // Cacher apr√®s 5 sec
        setTimeout(() => {
            banner.style.opacity = '0';
            setTimeout(() => { banner.style.display = 'none'; }, 400);
        }, 5000);
    }

    showNextNotif();
    notifLoopInterval = setInterval(showNextNotif, 10000);
}

function stopClientNotifLoop() {
    if (notifLoopInterval) { clearInterval(notifLoopInterval); notifLoopInterval = null; }
    const banner = document.getElementById('clientNotifBanner');
    if (banner) banner.style.display = 'none';
}

// D√©marrer la boucle notif apr√®s connexion ‚Äî appel√© depuis le showClientInterface unifi√©
window._startNotifLoop = function() {
    setTimeout(startClientNotifLoop, 600);
};

// Hooker logoutClient pour arr√™ter la boucle
const _origLogoutClient = window.logoutClient;
window.logoutClient = function() {
    stopClientNotifLoop();
    if (_origLogoutClient) _origLogoutClient();
};

// Hooker showAdminPanel pour charger les donn√©es notifications
const _origShowAdminPanel = window.showAdminPanel;
window.showAdminPanel = function() {
    if (_origShowAdminPanel) _origShowAdminPanel();
    setTimeout(() => {
        window.populateNotifAccountSelect();
        window.loadNotificationsTable();
    }, 100);
};

// Hooker switchTab pour recharger quand on clique sur l'onglet Notifications
const _origSwitchTab = window.switchTab;
window.switchTab = function(tabName) {
    if (_origSwitchTab) _origSwitchTab.call(this, tabName);
    if (tabName === 'notifications') {
        setTimeout(() => {
            window.populateNotifAccountSelect();
            window.loadNotificationsTable();
        }, 50);
    }
};

console.log('‚úÖ Module Notifications charg√©');

// ============================================
// 1. MESSAGE DE BIENVENUE PERSONNALIS√â
// ============================================
function getGreeting() {
    const h = new Date().getHours();
    if (h >= 5  && h < 12) return 'Bonjour';
    if (h >= 12 && h < 18) return 'Bon apr√®s-midi';
    if (h >= 18 && h < 22) return 'Bonsoir';
    return 'Bonne nuit';
}

// ============================================
// 2. SPINNER DE CHARGEMENT
// ============================================
window.showSpinner = function(text) {
    const s = document.getElementById('loadingSpinner');
    if (!s) return;
    document.getElementById('spinnerText').textContent = text || 'Chargement...';
    s.style.display = 'flex';
};
window.hideSpinner = function() {
    const s = document.getElementById('loadingSpinner');
    if (s) s.style.display = 'none';
};

// ============================================
// 3. D√âCONNEXION AUTOMATIQUE (10 min d'inactivit√©)
// ============================================
let inactivityTimer = null;
const INACTIVITY_LIMIT = 10 * 60 * 1000; // 10 minutes

function resetInactivityTimer() {
    if (!window.currentUser) return;
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        if (!window.currentUser) return;
        stopClientNotifLoop && stopClientNotifLoop();
        window.currentUser = null;
        sessionStorage.removeItem('vantex_session');
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('clientInterface').style.display = 'none';
        document.getElementById('transferModal').style.display = 'none';
        document.getElementById('transferConfirmation').style.display = 'none';
        document.getElementById('transferProcessing').style.display = 'none';
        document.getElementById('loginForm').reset();
        alert('‚è∞ Vous avez √©t√© d√©connect√© automatiquement apr√®s 10 minutes d\'inactivit√©.');
    }, INACTIVITY_LIMIT);
}

['click','touchstart','keydown','scroll','mousemove'].forEach(evt =>
    document.addEventListener(evt, resetInactivityTimer, { passive: true })
);

// ============================================
// 4. D√âTAIL DE TRANSACTION AU CLIC
// ============================================
window.showTxDetail = function(idx) {
    const t = allHistoryCache[idx];
    if (!t) return;
    const currency = (t.currency) || (window.currentUser ? window.currentUser.currency || 'GNF' : 'GNF');
    const dateObj = new Date(t.date);
    const dateStr = dateObj.toLocaleDateString('fr-FR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
    const timeStr = dateObj.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
    const sign    = t.type === 'credit' ? '+' : '-';
    const color   = t.type === 'credit' ? '#27ae60' : '#e74c3c';
    const bgColor = t.type === 'credit' ? 'linear-gradient(135deg,#00b09b,#27ae60)' : 'linear-gradient(135deg,#e74c3c,#c0392b)';
    const ref     = 'VTX-' + String(t.id).slice(-8).toUpperCase();

    let icon = t.type === 'credit' ? 'üì®' : 'üì§';
    let label = t.type === 'credit' ? 'Virement re√ßu' : 'D√©bit effectu√©';
    if (t.sourceType === 'transfer') { icon = 'üè¶'; label = 'Virement envoy√©'; }
    if (t.note && t.note.toLowerCase().includes('frais')) { icon = 'üí∏'; label = 'Frais de transaction'; }
    if (t.transferType === 'mobile') { icon = 'üì±'; label = 'Transfert Mobile Money'; }

    // Ligne helper
    const row = (lbl, val, mono=false) => val ? `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-bottom:1px solid #f0f0f0;">
            <span style="color:#aaa;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;flex-shrink:0;">${lbl}</span>
            <span style="font-weight:700;font-size:13px;text-align:right;max-width:62%;${mono?'font-family:monospace;':''}">${val}</span>
        </div>` : '';

    // Bloc d√©tails sp√©cifiques au virement
    let extraRows = '';
    if (t.sourceType === 'transfer') {
        if (t.beneficiary) extraRows += row('B√©n√©ficiaire', t.beneficiary);
        if (t.transferType === 'mobile') {
            if (t.operator)      extraRows += row('Op√©rateur', t.operator);
            if (t.mobileNumber)  extraRows += row('Num√©ro mobile', t.mobileNumber, true);
            if (t.mobileCountry) extraRows += row('Pays', t.mobileCountry);
        } else {
            if (t.iban)  extraRows += row('IBAN / Compte', t.iban, true);
            if (t.swift) extraRows += row('BIC / SWIFT', t.swift, true);
            if (t.bank)  extraRows += row('Banque', t.bank);
        }
        if (t.reason) extraRows += row('Motif', t.reason);
        if (t.fee && t.fee > 0) extraRows += row('Frais', formatCurrency(t.fee) + ' ' + currency);
    }

    // Statut badge
    const statusMap = {
        'completed': ['‚úÖ R√©ussi', '#d4edda', '#155724'],
        'failed':    ['‚ùå √âchou√©', '#f8d7da', '#721c24'],
        'processing':['‚è≥ En cours', '#fff3cd', '#856404'],
    };
    const [statusTxt, statusBg, statusColor] = statusMap[t.status] || ['‚úÖ Confirm√©', '#d4edda', '#155724'];

    document.getElementById('txDetailContent').innerHTML = `
        <!-- En-t√™te color√© -->
        <div style="background:${bgColor};border-radius:18px;padding:24px 20px;text-align:center;margin-bottom:18px;">
            <div style="width:56px;height:56px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 12px;">${icon}</div>
            <div style="font-size:28px;font-weight:900;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.2);">${sign}${formatCurrency(t.amount)} ${currency}</div>
            <div style="font-size:13px;color:rgba(255,255,255,0.85);margin-top:4px;font-weight:600;">${label}</div>
            <div style="background:rgba(255,255,255,0.2);border-radius:8px;padding:4px 12px;display:inline-block;margin-top:10px;">
                <span style="color:white;font-size:11px;font-family:monospace;font-weight:700;">${ref}</span>
            </div>
        </div>

        <!-- D√©tails -->
        <div style="background:#f8faff;border-radius:18px;padding:4px 16px;margin-bottom:14px;">
            ${row('Date', dateStr)}
            ${row('Heure', timeStr)}
            ${row('Type', t.type === 'credit' ? '‚¨ÜÔ∏è Entr√©e' : '‚¨áÔ∏è Sortie')}
            ${extraRows}
            <div style="display:flex;justify-content:space-between;align-items:center;padding:11px 0;">
                <span style="color:#aaa;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Statut</span>
                <span style="background:${statusBg};color:${statusColor};padding:4px 12px;border-radius:8px;font-size:12px;font-weight:700;">${statusTxt}</span>
            </div>
        </div>
        <div style="padding:0 20px;margin-top:4px;">
            <button onclick="closeTxDetail()" style="width:100%;padding:15px;background:linear-gradient(135deg,#0052cc,#0091ff);color:white;border:none;border-radius:16px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(0,82,204,0.3);">Fermer</button>
        </div>
    `;
    const modal = document.getElementById('txDetailModal');
    modal.style.display = 'flex';
};

window.closeTxDetail = function() {
    document.getElementById('txDetailModal').style.display = 'none';
};

// ============================================
// 5. RECHERCHE / FILTRE TRANSACTIONS
// ============================================
window.filterTransactions = function() {
    const query  = (document.getElementById('txSearchInput')?.value || '').toLowerCase();
    const filter = document.getElementById('txFilterType')?.value || 'all';
    const currency = window.currentUser ? (window.currentUser.currency || 'GNF') : 'GNF';

    const filtered = allHistoryCache.filter(t => {
        const matchType = filter === 'all' || t.type === filter;
        const searchStr = (t.note || '') + ' ' + formatCurrency(t.amount) + ' ' + t.date;
        const matchQuery = !query || searchStr.toLowerCase().includes(query);
        return matchType && matchQuery;
    });

    renderTransactionList(filtered, currency);
};

function renderTransactionList(list, currency) {
    const listDiv = document.getElementById('transactionsList');
    if (list.length === 0) {
        listDiv.innerHTML = `<div class="no-transactions"><div class="no-transactions-icon">üîç</div><p>Aucune transaction trouv√©e.</p></div>`;
        return;
    }
    listDiv.innerHTML = list.map((t, idx) => {
        const realIdx = allHistoryCache.indexOf(t);
        let icon = t.type === 'credit' ? 'üì•' : 'üì§';
        let label = t.type === 'credit' ? 'D√©p√¥t' : 'Retrait';
        if (t.sourceType === 'transfer') { icon = 'üè¶'; label = 'Virement'; }
        if (t.note && t.note.toLowerCase().includes('frais')) { icon = 'üí∏'; label = 'Frais'; }
        if (t.note && t.note.toLowerCase().includes('recharge')) { icon = 'üì®'; label = 'Virement re√ßu'; }
        const dateObj = new Date(t.date);
        const dateStr = dateObj.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit', year:'numeric' });
        const timeStr = dateObj.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
        const statusBadge = t.sourceType === 'transfer' && t.status ?
            `<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:${t.status==='completed'?'#d4edda':t.status==='failed'?'#f8d7da':'#fff3cd'};color:${t.status==='completed'?'#155724':t.status==='failed'?'#721c24':'#856404'};">${t.status==='completed'?'R√©ussi':t.status==='failed'?'√âchou√©':'En cours'}</span>` : '';
        return `
        <div class="transaction-item" style="border-left:3px solid ${t.type==='credit'?'#27ae60':'#e74c3c'}; cursor:pointer;" onclick="showTxDetail(${realIdx})">
            <div class="transaction-info">
                <h4 style="display:flex;align-items:center;gap:6px;">${icon} ${label} ${statusBadge}</h4>
                <p class="transaction-date">üìÖ ${dateStr} √† ${timeStr}</p>
                ${t.note ? `<p class="transaction-date" style="color:#888;">${t.note}</p>` : ''}
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                <div class="transaction-amount ${t.type === 'credit' ? 'positive' : 'negative'}">
                    ${t.type === 'credit' ? '+' : '-'}${formatCurrency(t.amount)} ${currency}
                </div>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
            </div>
        </div>`;
    }).join('');
}

// ============================================
// 6. CONFIRMATION PAR CODE PIN
// ============================================
let _pinCallback = null;
let _pinCancelCallback = null;

window.requirePin = function(title, desc, onSuccess, onCancel) {
    _pinCallback = onSuccess;
    _pinCancelCallback = onCancel || null;
    document.getElementById('pinModalTitle').textContent = title || 'Confirmation requise';
    document.getElementById('pinModalDesc').textContent  = desc  || 'Saisissez votre code PIN pour confirmer';
    document.getElementById('pinInput').value = '';
    document.getElementById('pinError').textContent = '';
    const modal = document.getElementById('pinConfirmModal');
    modal.style.display = 'flex';
    setTimeout(() => document.getElementById('pinInput').focus(), 100);
};

window.validatePin = function() {
    const entered = document.getElementById('pinInput').value;
    if (!window.currentUser) return;
    if (entered === window.currentUser.password) {
        document.getElementById('pinConfirmModal').style.display = 'none';
        if (_pinCallback) _pinCallback();
        _pinCallback = null;
    } else {
        document.getElementById('pinError').textContent = '‚ùå Code PIN incorrect';
        document.getElementById('pinInput').value = '';
        document.getElementById('pinInput').focus();
    }
};

window.cancelPinConfirm = function() {
    document.getElementById('pinConfirmModal').style.display = 'none';
    if (_pinCancelCallback) _pinCancelCallback();
    _pinCallback = null;
    _pinCancelCallback = null;
};

// PIN requis avant d√©connexion
const _origLogoutClientFinal = window.logoutClient;
window.logoutClient = function() {
    requirePin(
        'D√©connexion',
        'Confirmez votre code PIN pour vous d√©connecter',
        () => {
            stopClientNotifLoop && stopClientNotifLoop();
            window.currentUser = null;
            sessionStorage.removeItem('vantex_session');
            document.getElementById('profileModalOverlay').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('clientInterface').style.display = 'none';
            document.getElementById('loginForm').reset();
        }
    );
};

// PIN requis avant virement (override de processTransfer)
const _origProcessTransferFinal = window.processTransfer;
window.processTransfer = function() {
    // Le code d'activation remplace le PIN pour les virements ‚Äî on garde l'existant
    if (_origProcessTransferFinal) _origProcessTransferFinal();
};

// Greeting ‚Äî appel√© depuis le showClientInterface unifi√©
window._updateGreeting = function() {
    const greeting = getGreeting();
    const welcomeEl = document.getElementById('welcomeMsg');
    if (welcomeEl && window.currentUser) {
        const firstName = window.currentUser.firstName || window.currentUser.name.split(' ')[0];
        welcomeEl.innerHTML = `${greeting}, <span id="userName">${firstName}</span> üëã`;
    }
    resetInactivityTimer();
};

// ============================================
// 8. SPINNER pendant le login
// ============================================
document.getElementById('loginForm').addEventListener('submit', function() {
    showSpinner('Connexion en cours...');
    setTimeout(hideSpinner, 3000);
}, true);

console.log('‚úÖ Toutes les fonctionnalit√©s avanc√©es charg√©es');

// ============================================
// DASHBOARD MODERNE
// ============================================

// Badge derni√®re connexion
function updateLastLoginBadge() {
    const key = 'vantex_last_login_' + (window.currentUser ? window.currentUser.email : '');
    const prev = localStorage.getItem(key);
    const now  = new Date();
    const badge = document.getElementById('lastLoginBadge');
    if (badge) {
        if (prev) {
            const d = new Date(prev);
            const dateStr = d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit', year:'numeric' });
            const timeStr = d.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
            badge.textContent = 'üîí Derni√®re connexion : ' + dateStr + ' √† ' + timeStr;
        } else {
            badge.textContent = 'üîí Premi√®re connexion';
        }
    }
    localStorage.setItem(key, now.toISOString());
}

// Num√©ro de compte masqu√©
function updateAccountMeta() {
    if (!window.currentUser) return;
    const id = String(window.currentUser.id || '0');
    const masked = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + id.slice(-4).padStart(4, '0');
    const el = document.getElementById('accountNumMasked');
    if (el) el.textContent = masked;
}

// R√©sum√© financier du mois courant
function updateFinanceSummary() {
    if (!window.currentUser) return;
    const currency = window.currentUser.currency || 'GNF';
    const transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
    const now = new Date();
    const thisMonth = now.getMonth();
    const thisYear  = now.getFullYear();

    let income = 0, expense = 0;
    transactions
        .filter(t => t.accountEmail === window.currentUser.email)
        .forEach(t => {
            const d = new Date(t.date);
            if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) {
                if (t.type === 'credit') income  += t.amount;
                else                     expense += t.amount;
            }
        });

    const iEl = document.getElementById('monthIncome');
    const eEl = document.getElementById('monthExpense');
    if (iEl) iEl.textContent  = formatCurrency(income)  + ' ' + currency;
    if (eEl) eEl.textContent  = formatCurrency(expense) + ' ' + currency;
}

// Sparkline 7 jours
function drawSparkline() {
    const canvas = document.getElementById('sparklineCanvas');
    if (!canvas || !window.currentUser) return;

    const transactions = JSON.parse(localStorage.getItem('vantex_transactions') || '[]');
    const userTx = transactions.filter(t => t.accountEmail === window.currentUser.email);

    // Construire les 7 derniers jours
    const days = [];
    const labels = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        days.push(d);
        labels.push(d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit' }));
    }

    const dayTotals = days.map(day => {
        const dayStr = day.toDateString();
        let net = 0;
        userTx.forEach(t => {
            if (new Date(t.date).toDateString() === dayStr) {
                net += t.type === 'credit' ? t.amount : -t.amount;
            }
        });
        return net;
    });

    // Dessiner
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 300;
    const H = 50;
    canvas.width  = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width  = W + 'px';
    canvas.style.height = H + 'px';
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);

    const max = Math.max(...dayTotals.map(Math.abs), 1);
    const mid = H / 2;
    const stepX = W / (days.length - 1);

    // Points
    const pts = dayTotals.map((v, i) => ({
        x: i * stepX,
        y: mid - (v / max) * (mid - 8)
    }));

    // Gradient fill
    const grad = ctx.createLinearGradient(0, 0, 0, H);
    grad.addColorStop(0, 'rgba(255,255,255,0.25)');
    grad.addColorStop(1, 'rgba(255,255,255,0.02)');

    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    pts.forEach((p, i) => {
        if (i > 0) {
            const cp1x = pts[i-1].x + stepX * 0.4;
            const cp2x = p.x - stepX * 0.4;
            ctx.bezierCurveTo(cp1x, pts[i-1].y, cp2x, p.y, p.x, p.y);
        }
    });
    ctx.lineTo(W, H);
    ctx.lineTo(0, H);
    ctx.closePath();
    ctx.fillStyle = grad;
    ctx.fill();

    // Ligne
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    pts.forEach((p, i) => {
        if (i > 0) {
            const cp1x = pts[i-1].x + stepX * 0.4;
            const cp2x = p.x - stepX * 0.4;
            ctx.bezierCurveTo(cp1x, pts[i-1].y, cp2x, p.y, p.x, p.y);
        }
    });
    ctx.strokeStyle = 'rgba(255,255,255,0.8)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Points
    pts.forEach((p, i) => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
        ctx.fillStyle = 'white';
        ctx.fill();
    });

    // Labels
    ctx.font = '9px sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.textAlign = 'center';
    labels.forEach((l, i) => ctx.fillText(l, i * stepX, H - 2));
}

// Transactions group√©es par date
const _origRenderTxList = window.renderTransactionList;
window.renderTransactionList = function(list, currency) {
    const listDiv = document.getElementById('transactionsList');
    if (!list || list.length === 0) {
        listDiv.innerHTML = `<div class="no-transactions"><div class="no-transactions-icon">üìã</div><p>Aucune transaction effectu√©e.</p></div>`;
        return;
    }

    // Grouper par date
    const groups = {};
    list.forEach((t, idx) => {
        const d    = new Date(t.date);
        const now  = new Date();
        const yesterday = new Date(); yesterday.setDate(now.getDate() - 1);
        let groupKey;
        if (d.toDateString() === now.toDateString())       groupKey = "Aujourd'hui";
        else if (d.toDateString() === yesterday.toDateString()) groupKey = 'Hier';
        else groupKey = d.toLocaleDateString('fr-FR', { weekday:'long', day:'2-digit', month:'long' });
        if (!groups[groupKey]) groups[groupKey] = [];
        groups[groupKey].push({ t, realIdx: allHistoryCache.indexOf(t) });
    });

    let html = '';
    Object.entries(groups).forEach(([groupLabel, items]) => {
        html += `<div class="tx-date-group">${groupLabel}</div>`;
        items.forEach(({ t, realIdx }) => {
            const color = t.type === 'credit' ? '#27ae60' : '#e74c3c';
            const bg    = t.type === 'credit' ? '#e8f5e9' : '#ffebee';
            let icon = t.type === 'credit' ? '‚Üì' : '‚Üë';
            let label = t.type === 'credit' ? 'Re√ßu' : 'Envoy√©';
            if (t.sourceType === 'transfer') { icon = '‚Üí'; label = 'Virement'; }
            if (t.note && t.note.toLowerCase().includes('frais')) { icon = '%'; label = 'Frais'; }
            if (t.note && t.note.toLowerCase().includes('recharge')) { icon = '‚Üì'; label = 'Virement re√ßu'; }
            const timeStr = new Date(t.date).toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
            const sign    = t.type === 'credit' ? '+' : '-';
            const statusBadge = t.sourceType === 'transfer' && t.status ?
                `<span style="font-size:9px;padding:1px 6px;border-radius:4px;background:${t.status==='completed'?'#d4edda':t.status==='failed'?'#f8d7da':'#fff3cd'};color:${t.status==='completed'?'#155724':t.status==='failed'?'#721c24':'#856404'};">${t.status==='completed'?'‚úì':'‚è≥'}</span>` : '';
            html += `
            <div class="transaction-item" style="border-left:3px solid ${color}; cursor:pointer;" onclick="showTxDetail(${realIdx})">
                <div style="display:flex;align-items:center;gap:12px;flex:1;min-width:0;">
                    <div style="width:38px;height:38px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:800;font-size:16px;color:${color};">${icon}</div>
                    <div style="min-width:0;">
                        <div style="font-weight:700;font-size:13px;color:#222;display:flex;align-items:center;gap:5px;">${label} ${statusBadge}</div>
                        <div style="font-size:11px;color:#aaa;margin-top:1px;">${timeStr}${t.note ? ' ¬∑ ' + t.note.substring(0,28) + (t.note.length>28?'‚Ä¶':'') : ''}</div>
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0;">
                    <div style="font-weight:800;font-size:14px;color:${color};">${sign}${formatCurrency(t.amount)} ${currency}</div>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#ddd" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
                </div>
            </div>`;
        });
    });
    listDiv.innerHTML = html;
};

// ============================================
// OVERRIDE UNIQUE showClientInterface ‚Äî TOUT ICI
// ============================================
const _origSCI_base = window.showClientInterface;
window.showClientInterface = function() {
    // 1. R√©initialiser le bouton ≈ìil et l'√©tat du solde
    window.balanceVisible = true;
    const balanceEl = document.getElementById('clientBalance');
    const eyeOpen   = document.getElementById('eyeOpenIcon');
    const eyeClosed = document.getElementById('eyeClosedIcon');
    if (balanceEl)  { balanceEl.style.filter = 'none'; balanceEl.style.opacity = '1'; }
    if (eyeOpen)    eyeOpen.style.display  = 'block';
    if (eyeClosed)  eyeClosed.style.display = 'none';

    // 2. Appeler la fonction originale
    if (_origSCI_base) _origSCI_base();

    // 3. Greeting + inactivit√©
    window._updateGreeting && window._updateGreeting();

    // 4. Notifications
    window._startNotifLoop && window._startNotifLoop();

    // 5. Dashboard moderne
    updateLastLoginBadge();
    updateAccountMeta();
    setTimeout(() => {
        updateFinanceSummary();
        drawSparkline();
    }, 300);
};

// Redessiner le sparkline si la fen√™tre change de taille
window.addEventListener('resize', () => {
    if (window.currentUser) drawSparkline();
});
</script>
</script>
<script>
function generateCardNumber(){const p='4532';let n=p;for(let i=0;i<12;i++)n+=Math.floor(Math.random()*10);return n.match(/.{1,4}/g).join(' ')}function generateExpirationDate(){const now=new Date();const y=now.getFullYear()+Math.floor(Math.random()*3)+2;const m=Math.floor(Math.random()*12)+1;return(m<10?'0':'')+m+'/'+y.toString().slice(-2)}function generateCVV(){return Math.floor(Math.random()*900)+100}function initializeVirtualCards(){const accounts=JSON.parse(localStorage.getItem('vantex_accounts')||'[]');let updated=false;accounts.forEach(account=>{if(!account.virtualCard){account.virtualCard={number:generateCardNumber(),expiration:generateExpirationDate(),cvv:generateCVV(),createdAt:new Date().toISOString()};updated=true}});if(updated){localStorage.setItem('vantex_accounts',JSON.stringify(accounts))}}function showVirtualCard(){const existing=document.getElementById('virtualCardModal');if(existing)existing.remove();const modal=document.createElement('div');modal.id='virtualCardModal';modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:99999;display:flex;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);';const card=currentUser.virtualCard||{number:generateCardNumber(),expiration:generateExpirationDate(),cvv:generateCVV()};const num=card.number;const maskedNum=num.replace(/^(\d{4} \d{4} \d{4}) /,'**** **** **** ');modal.innerHTML=`<div style="background:white;border-radius:28px 28px 0 0;padding:0 0 40px;width:100%;max-width:500px;animation:slideUp 0.4s ease;max-height:92vh;overflow-y:auto;">
  <div style="width:40px;height:4px;background:#e0e0e0;border-radius:2px;margin:14px auto 20px;"></div>
  <div style="padding:0 20px 20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;">
      <h3 style="margin:0;font-size:20px;font-weight:800;color:#111;">Ma Carte Virtuelle</h3>
      <button onclick="document.getElementById('virtualCardModal').remove()" style="width:36px;height:36px;background:#f5f5f5;border:none;border-radius:50%;font-size:18px;cursor:pointer;color:#666;display:flex;align-items:center;justify-content:center;">√ó</button>
    </div>

    <!-- Carte visuelle premium -->
    <div style="background:linear-gradient(135deg,#1a1a2e 0%,#16213e 40%,#0f3460 70%,#533483 100%);border-radius:22px;padding:26px 24px;color:white;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.4);margin-bottom:20px;min-height:200px;">
      <!-- Cercles d√©coratifs -->
      <div style="position:absolute;top:-30px;right:-30px;width:180px;height:180px;border-radius:50%;background:rgba(255,255,255,0.05);"></div>
      <div style="position:absolute;bottom:-50px;left:-20px;width:220px;height:220px;border-radius:50%;background:rgba(255,255,255,0.04);"></div>
      <!-- Puce chip -->
      <div style="position:absolute;top:26px;left:24px;display:flex;align-items:center;gap:10px;">
        <div style="width:42px;height:32px;background:linear-gradient(135deg,#f4d03f,#f39c12);border-radius:6px;display:grid;grid-template-columns:1fr 1fr;gap:2px;padding:4px;opacity:0.9;">
          <div style="background:rgba(0,0,0,0.2);border-radius:2px;"></div><div style="background:rgba(0,0,0,0.2);border-radius:2px;"></div>
          <div style="background:rgba(0,0,0,0.2);border-radius:2px;"></div><div style="background:rgba(0,0,0,0.2);border-radius:2px;"></div>
        </div>
        <div style="font-size:22px;font-weight:900;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,0.3);">VANTEX</div>
      </div>
      <!-- Logo r√©seau -->
      <div style="position:absolute;top:22px;right:24px;display:flex;gap:-6px;">
        <div style="width:34px;height:34px;border-radius:50%;background:rgba(235,68,68,0.85);"></div>
        <div style="width:34px;height:34px;border-radius:50%;background:rgba(255,165,0,0.85);margin-left:-12px;"></div>
      </div>
      <!-- Num√©ro carte -->
      <div style="margin-top:70px;margin-bottom:20px;font-size:20px;font-weight:700;letter-spacing:4px;font-family:'Courier New',monospace;text-shadow:0 2px 4px rgba(0,0,0,0.3);">${card.number}</div>
      <!-- Infos bas de carte -->
      <div style="display:flex;justify-content:space-between;align-items:flex-end;">
        <div>
          <div style="font-size:9px;opacity:0.6;letter-spacing:1.5px;margin-bottom:3px;">TITULAIRE</div>
          <div style="font-size:14px;font-weight:700;letter-spacing:1px;">${currentUser.name.toUpperCase()}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:9px;opacity:0.6;letter-spacing:1.5px;margin-bottom:3px;">EXPIRE FIN</div>
          <div style="font-size:16px;font-weight:700;">${card.expiration}</div>
        </div>
      </div>
    </div>

    <!-- Infos carte -->
    <div style="background:#f8faff;border-radius:18px;padding:18px;margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid #eef0f4;">
        <div>
          <p style="color:#aaa;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;margin:0 0 4px;">Num√©ro de carte</p>
          <p style="font-weight:700;font-size:15px;margin:0;font-family:'Courier New',monospace;color:#111;">${card.number}</p>
        </div>
        <button id="copyCardBtn" onclick="copyToClipboard('${card.number.replace(/ /g,'')}');this.innerHTML='‚úÖ Copi√©!';this.style.background='#27ae60';setTimeout(()=>{this.innerHTML='üìã Copier';this.style.background='linear-gradient(135deg,#0052cc,#0091ff)'},2000)" style="padding:10px 16px;background:linear-gradient(135deg,#0052cc,#0091ff);color:white;border:none;border-radius:12px;cursor:pointer;font-size:13px;font-weight:700;white-space:nowrap;box-shadow:0 4px 12px rgba(0,82,204,0.3);">üìã Copier</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div>
          <p style="color:#aaa;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;margin:0 0 4px;">Date d'expiration</p>
          <p style="font-weight:800;font-size:18px;margin:0;color:#111;">${card.expiration}</p>
        </div>
        <div>
          <p style="color:#aaa;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;margin:0 0 4px;">CVV</p>
          <p style="font-weight:800;font-size:18px;margin:0;color:#111;">${card.cvv}</p>
        </div>
      </div>
    </div>

    <!-- Avertissement -->
    <div style="background:linear-gradient(135deg,#fff8e1,#fff3cd);border-radius:14px;padding:14px 16px;border-left:4px solid #f39c12;margin-bottom:16px;display:flex;align-items:center;gap:10px;">
      <span style="font-size:20px;flex-shrink:0;">üîí</span>
      <p style="margin:0;color:#856404;font-size:13px;font-weight:600;">Ne partagez jamais vos informations de carte.</p>
    </div>

    <!-- Bouton fermer -->
    <button onclick="document.getElementById('virtualCardModal').remove()" style="width:100%;padding:15px;background:linear-gradient(135deg,#0052cc,#0091ff);color:white;border:none;border-radius:16px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(0,82,204,0.3);">Fermer</button>
  </div>
</div>`;document.body.appendChild(modal);modal.addEventListener('click',function(e){if(e.target===modal)modal.remove()})}function copyToClipboard(text){const t=document.createElement('textarea');t.value=text;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);alert('‚úÖ Copi√©!')}function editVirtualCard(accountId){const accounts=JSON.parse(localStorage.getItem('vantex_accounts'));const account=accounts.find(acc=>acc.id===accountId);if(!account)return;const card=account.virtualCard||{number:generateCardNumber(),expiration:generateExpirationDate(),cvv:generateCVV()};const modal=document.createElement('div');modal.className='modal active';modal.id='editCardModal';modal.innerHTML=`<div class="modal-content"><div class="modal-header"><h3>üí≥ Carte de ${account.name}</h3><button class="close-modal" onclick="closeEditCardModal()">√ó</button></div><form onsubmit="saveVirtualCard(${accountId});return false"><div class="form-group"><label>Num√©ro de carte</label><input type="text" id="cardNumber" value="${card.number}" maxlength="19" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px"><button type="button" onclick="document.getElementById('cardNumber').value=generateCardNumber()" style="margin-top:8px;padding:8px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer">üé≤ G√©n√©rer</button></div><div class="form-row"><div class="form-group"><label>Expiration (MM/AA)</label><input type="text" id="cardExpiration" value="${card.expiration}" maxlength="5" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px"><button type="button" onclick="document.getElementById('cardExpiration').value=generateExpirationDate()" style="margin-top:8px;padding:6px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer">üé≤</button></div><div class="form-group"><label>CVV</label><input type="text" id="cardCVV" value="${card.cvv}" maxlength="3" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px"><button type="button" onclick="document.getElementById('cardCVV').value=generateCVV()" style="margin-top:8px;padding:6px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer">üé≤</button></div></div><button type="submit" class="btn btn-primary" style="margin-top:15px">üíæ Enregistrer</button></form></div>`;document.body.appendChild(modal)}function saveVirtualCard(accountId){const cardNumber=document.getElementById('cardNumber').value.trim();const expiration=document.getElementById('cardExpiration').value.trim();const cvv=document.getElementById('cardCVV').value.trim();if(!cardNumber||cardNumber.replace(/\s/g,'').length!==16){alert('16 chiffres requis');return}if(!expiration.match(/^\d{2}\/\d{2}$/)){alert('Format: MM/AA');return}if(!cvv||cvv.length!==3){alert('CVV: 3 chiffres');return}const accounts=JSON.parse(localStorage.getItem('vantex_accounts'));const account=accounts.find(acc=>acc.id===accountId);account.virtualCard={number:cardNumber,expiration:expiration,cvv:cvv,updatedAt:new Date().toISOString()};localStorage.setItem('vantex_accounts',JSON.stringify(accounts));closeEditCardModal();loadAccountsTable();alert('‚úÖ Carte mise √† jour!')}function closeEditCardModal(){const modal=document.getElementById('editCardModal');if(modal)modal.remove()}initializeVirtualCards();console.log('‚úÖ Cartes virtuelles activ√©es');
</script>
</body>
</html>